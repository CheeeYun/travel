<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šäººå”ä½œæ—…éŠæ¸…å–® - è¨˜å¸³èˆ‡é ç®—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a clean, mobile-first design */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F8FF; /* Light blue-white for a subtle ocean/sand feel */
        }
        .tab-active {
            border-bottom: 4px solid #06B6D4; /* Cyan 600 border for active tab (Okinawa Ocean) */
            color: #1F2937; /* Dark text */
            font-weight: 600;
        }
        .list-item-card {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s;
        }
        
        /* Interactive buttons */
        .packed-btn { background-color: #059669; color: white; box-shadow: 0 2px 4px rgba(5, 150, 105, 0.4); } /* Emerald 600 for Packed */
        .unpack-btn { background-color: #FBBF24; color: #78350F; box-shadow: 0 2px 4px rgba(251, 191, 36, 0.4); } /* Yellow for Unpacked/Warning */
        .luggage-tag { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 9999px; }

        /* Budget Styles */
        .fixed-budget-card { border-left: 5px solid #0E7490; } /* Deep Cyan 700 - Fixed Costs NT$ */
        .expense-record-card { border-left: 3px solid #F97316; } /* Orange 600 for expense - Variable Costs JPYÂ¥ */
        .total-summary-card { background-color: #0891B2; } /* Cyan 700 - Stronger Blue */

        /* Itinerary Flight Card */
        .flight-card {
            background-color: #ECFEFF; /* Cyan 50 - Very Light Blue */
            border: 1px solid #67E8F9; /* Cyan 300 */
        }
        
        /* User Selector */
        #user-selector-container {
            border-bottom: 1px solid #E5E7EB;
        }
        .user-tag {
            cursor: pointer;
            transition: all 0.2s;
        }
        .user-tag-active {
            background-color: #06B6D4; /* Cyan 600 */
            color: white;
            box-shadow: 0 2px 4px rgba(6, 182, 212, 0.4);
        }
        
        /* Tab Icons Style - UPDATED: Increased size and centered for icon-only display */
        .tab-icon {
            width: 1.75rem;
            height: 1.75rem;
        }
    </style>
</head>
<body class="min-h-screen">

<div class="max-w-md mx-auto bg-white min-h-screen">
    
    <!-- Loading/Status Indicator -->
    <div id="loadingIndicator" class="p-4 text-center bg-yellow-100 text-yellow-800 font-semibold">
        è¼‰å…¥ä¸­... æ­£åœ¨å»ºç«‹é€£ç·š...
    </div>

    <!-- UPDATED: User Selector for Packing List and Budget -->
    <div id="user-selector-container" class="p-3 bg-white hidden">
        <p class="text-sm font-semibold text-gray-600 mb-2">æ—…ä¼´æ¸…å–®/è¨˜å¸³ç°¿:</p>
        <div id="userSelector" class="flex space-x-2 overflow-x-auto pb-2">
            <!-- User tags will be inserted here -->
        </div>
    </div>


    <!-- UPDATED: Header/Tab Navigation with Icons Only -->
    <div class="flex justify-around border-b border-gray-200 p-3 bg-white">
        <!-- Itinerary Tab: è¡Œç¨‹ç´°ç¯€ (Clipboard List Icon) -->
        <div id="tabItinerary" class="text-center p-2 cursor-pointer tab-active flex flex-col items-center justify-center w-1/4" onclick="showTab('itinerary')">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/>
            </svg>
        </div>
        <!-- Map Tab: åœ°åœ–å°èˆª (Map Pin Icon) -->
        <div id="tabMap" class="text-center p-2 text-gray-500 hover:text-gray-700 cursor-pointer flex flex-col items-center justify-center w-1/4" onclick="showTab('map')">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>
            </svg>
        </div>
        <!-- Budget Tab: èŠ±è²»é ç®— (Wallet Icon) -->
        <div id="tabBudget" class="text-center p-2 text-gray-500 hover:text-gray-700 cursor-pointer flex flex-col items-center justify-center w-1/4" onclick="showTab('budget')">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="20" height="16" x="2" y="4" rx="2" ry="2"/>
                <path d="M22 7.5H4"/>
                <path d="M12 11h.01"/>
                <path d="M17 11h.01"/>
            </svg>
        </div>
        <!-- Packing Tab: è¡Œææ¸…å–® (Briefcase Icon) -->
        <div id="tabPacking" class="text-center p-2 text-gray-500 hover:text-gray-700 cursor-pointer flex flex-col items-center justify-center w-1/4" onclick="showTab('packing')">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="20" height="14" x="2" y="7" rx="2"/><path d="M14 2h-4a2 2 0 0 0-2 2v3h8V4a2 2 0 0 0-2-2Z"/>
            </svg>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="p-4">

        <!-- Tab 1: è¡Œç¨‹ç´°ç¯€ (Default View) -->
        <div id="itineraryDetailView" class="space-y-6">
            <div id="itineraryDetailContent">
                <p class="text-center text-gray-500 py-10">æ­£åœ¨åŒæ­¥è¡Œç¨‹è³‡æ–™...</p>
            </div>
        </div>

        <!-- Tab 2: åœ°åœ–å°èˆª (NEW View) -->
        <div id="mapView" class="space-y-6 hidden">
            <p class="text-sm text-gray-600 mb-4 bg-cyan-50 p-3 rounded-lg border-l-4 border-cyan-400">
                é»æ“Šåœ°é»æ—çš„ã€Œå°èˆªã€æŒ‰éˆ•ï¼Œå³å¯åœ¨æ–°è¦–çª—ä¸­é–‹å•Ÿ Google åœ°åœ–é€²è¡Œæœå°‹ã€‚ä¸‹æ–¹æ–°å¢äº†åœ°é»æ™¯é»ç‰¹è‰²ä¾›åƒè€ƒã€‚
            </p>
            <div id="mapContent">
                <p class="text-center text-gray-500 py-10">æ­£åœ¨æ•´ç†åœ°é»è³‡è¨Š...</p>
            </div>
        </div>
        
        <!-- Tab 3: èŠ±è²»é ç®— (Expense Tracker) -->
        <div id="budgetView" class="space-y-6 hidden">
            <p id="budgetTravelerMessage" class="text-sm font-semibold mb-4 bg-purple-100 p-3 rounded-lg border-l-4 border-purple-400 text-purple-800">
                æ‚¨æ­£åœ¨æª¢è¦–çš„æ˜¯ **å€‹äºº** å›ºå®šè²»ç”¨èˆ‡è®Šå‹•è¨˜å¸³ã€‚
            </p>

            <!-- Fixed Expenses Summary -->
            <div id="fixedExpensesSummary"></div>

            <!-- Expense Tracking Form -->
            <div class="bg-white rounded-lg p-4 shadow-lg border border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">æ–°å¢å€‹äººèŠ±è²»</h3>
                <form id="expenseForm" onsubmit="addExpense(event)">
                    <div class="mb-3">
                        <label for="expenseDescription" class="block text-sm font-medium text-gray-700">é …ç›®æè¿° (å¿…å¡«)</label>
                        <input type="text" id="expenseDescription" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-cyan-600 focus:border-cyan-600">
                    </div>
                    <div class="flex space-x-3 mb-3">
                        <div class="flex-1">
                            <label for="expenseAmount" class="block text-sm font-medium text-gray-700">é‡‘é¡ (JPYÂ¥)</label>
                            <input type="number" id="expenseAmount" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-cyan-600 focus:border-cyan-600">
                        </div>
                        <div class="flex-1">
                            <label for="expenseCategory" class="block text-sm font-medium text-gray-700">é¡åˆ¥</label>
                            <select id="expenseCategory" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white focus:ring-cyan-600 focus:border-cyan-600">
                                <option value="é¤é£²èˆ‡é›¶é£Ÿ">é¤é£²èˆ‡é›¶é£Ÿ</option>
                                <option value="è³¼ç‰©èˆ‡ç´€å¿µå“">è³¼ç‰©èˆ‡ç´€å¿µå“</option>
                                <option value="äº¤é€šèˆ‡æ²¹è²»">äº¤é€šèˆ‡æ²¹è²»</option>
                                <option value="æ™¯é»èˆ‡å¨›æ¨‚ (è‡¨è³¼)">æ™¯é»èˆ‡å¨›æ¨‚</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>

                    <!-- NEW: Payment Method Selection -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä»˜æ¬¾æ–¹å¼</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="paymentMethod" value="ç¾é‡‘" checked class="form-radio text-cyan-600 focus:ring-cyan-600 h-4 w-4">
                                <span class="ml-2 text-gray-700">ğŸ’µ ç¾é‡‘</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="paymentMethod" value="åˆ·å¡" class="form-radio text-cyan-600 focus:ring-cyan-600 h-4 w-4">
                                <span class="ml-2 text-gray-700">ğŸ’³ åˆ·å¡</span>
                            </label>
                        </div>
                    </div>

                    <button type="submit" id="addExpenseBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                        æ–°å¢è¨˜å¸³
                    </button>
                </form>
            </div>
            
            <!-- Expense Tracking List -->
            <div id="trackedExpensesList">
                <!-- Records and total sum will be rendered here -->
            </div>
        </div>

        <!-- Tab 4: è¡Œææ¸…å–® -->
        <div id="packingListView" class="space-y-6 hidden">
            <p id="packingListUserMessage" class="text-sm font-semibold mb-4 bg-yellow-100 p-3 rounded-lg border-l-4 border-yellow-400 text-yellow-800">
                æ‚¨æ­£åœ¨æª¢è¦–çš„æ˜¯**å€‹äºº**æ‰“åŒ…æ¸…å–®ã€‚è«‹åˆ‡æ›ä¸Šæ–¹çš„æ¨™ç±¤ä¾†æª¢è¦–ä¸åŒæ—…ä¼´çš„æ¸…å–®ã€‚
            </p>
            <div id="packingListContent">
                <p class="text-center text-gray-500 py-10">æ­£åœ¨åŒæ­¥æ¸…å–®è³‡æ–™...</p>
            </div>
        </div>

    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global Variables and Firebase Setup ---
    setLogLevel('Debug');
    
    // MANDATORY Canvas Global Variables
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;
    
    // Use a fixed public ID for this shared itinerary across all users.
    const SHARED_ITINERARY_ID = 'collaborative-trip-v4'; 
    
    // NEW: List of traveler names (Updated to 3 groups)
    const TRAVELER_NAMES = ['æŸè¨€ä½©çŠ (è² è²¬äºº)', 'çˆ¸çˆ¸åª½åª½', 'æŸå»·å¹¼å¨œ'];
    let currentSelectedTraveler = TRAVELER_NAMES[0]; // Default to the first traveler
    
    let currentItineraryData = null; // Store the full data snapshot
    let currentActiveTab = 'itinerary'; // Track the current active tab

    // Firestore Path: /artifacts/{appId}/public/data/itineraries/{SHARED_ITINERARY_ID}
    const getItineraryDocRef = () => {
        if (!db) return null;
        const path = `/artifacts/${appId}/public/data/itineraries/${SHARED_ITINERARY_ID}`;
        return doc(db, path);
    };

    // --- åœ°åœ–å’Œå°èˆªåœ°é» (Locations are static) ---
    const map_locations_data = [
        { name: "é£¯åº—å…¥ä½åœ°é»", location: "2-chÅme-1-15 Kumoji ä¹…èŒ‚åœ°ç¬¬ä¸€ãƒ“ãƒ« ï¼“éš", type: "ä½å®¿", day: 1, description: "åœ‹éš›é€šå‘¨é‚Šï¼Œäº¤é€šä¾¿åˆ©ï¼Œæ˜¯å››æ™šçš„ä½å®¿é»ã€‚" },
        // START UPDATED ORIX LOCATION
        { name: "ORIXç§Ÿè»Š (ç¾æ „æ©‹ç«™å‰å–è»Š)", location: "https://maps.app.goo.gl/J88aLvqwCAerdvFY6", type: "äº¤é€š", day: 2, description: "ORIX ç¾æ „æ©‹ç«™å‰å¤–èªæ«ƒæª¯å–è»Šï¼Œä½æ–¼é‚£éœ¸å¸‚ä¸­å¿ƒï¼Œäº¤é€šæ–¹ä¾¿ã€‚è¨˜å¾—æª¢æŸ¥åœ‹éš›é§•ç…§å’Œé ç´„å–®ã€‚" },
        // END UPDATED ORIX LOCATION
        { name: "ç¬¬ä¸€ç‰§å¿—å…¬è¨­å¸‚å ´", location: "ç¬¬ä¸€ç‰§å¿—å…¬è¨­å¸‚å ´", type: "æ™¯é»", day: 2, description: "æ²–ç¹©å»šæˆ¿ï¼å¯é¸è³¼æ–°é®®æµ·ç”¢ä¸¦ä»£å®¢æ–™ç†ï¼Œé«”é©—åœ¨åœ°ç¾é£Ÿæ–‡åŒ–ã€‚" },
        { name: "è±¬è‚‰è›‹é£¯ç³° (æ—©é¤)", location: "Pork Tamago Onigiri Makishi Market", type: "é¤é£²", day: 2, description: "å¿…åƒæ²–ç¹©ç¶“å…¸æ—©é¤ï¼Œæš–å‘¼å‘¼çš„é£¯ç³°æ­é…åˆé¤è‚‰å’Œé›è›‹ã€‚" },
        { name: "ç€¨é•·å³¶", location: "ç€¨é•·å³¶", type: "æ™¯é»", day: 2, description: "å°å³¶ä¸Šçš„ç™½è‰²å¸Œè‡˜é¢¨æ ¼èšè½ï¼Œæœ‰å„ç¨®ç‰¹è‰²å°åº—å’Œç„¡æ•µæµ·æ™¯ã€‚" },
        { name: "å¹¸ç¦é¬†é¤…", location: "å¹¸ç¦é¬†é¤… ç€¨é•·å³¶", type: "é¤é£²", day: 2, description: "è¶…äººæ°£æ’éšŠååº—ï¼Œä»¥è“¬é¬†æŸ”è»Ÿçš„èˆ’èŠ™è•¾é¬†é¤…èåã€‚" },
        { name: "æ°¾æ¿«æ¼¢å ¡", location: "æ°¾æ¿«æ¼¢å ¡ ç€¨é•·å³¶", type: "é¤é£²", day: 2, description: "ä»½é‡åè¶³ã€å¤šæ±ç¾å‘³çš„ç¾å¼æ¼¢å ¡ï¼Œé©åˆå¤§å£äº«ç”¨ã€‚" },
        { name: "ç‚­ç«ç„¼è‚‰ã¶ã¡ä¹…èŒ‚åœ°åº— (æ™šé¤)", location: "ç‚­ç«ç„¼è‚‰ã¶ã¡ä¹…èŒ‚åœ°åº—", type: "é¤é£²", day: 2, description: "å·²é è¨‚çš„æ™šé¤ç‡’è‚‰ï¼Œä¸»æ‰“é«˜å“è³ªç‚­ç«ç‡’è‚‰ï¼Œåˆ¥å¿˜äº†æº–æ™‚ã€‚" },
        // DAY 2 æ–°å¢åœ°é»
        { name: "å¡”å¯é£¯å’–å•¡", location: "https://maps.app.goo.gl/mKrYw7Z21zY1VxCM7", type: "é¤é£²", day: 2, description: "ç‰¹è‰²æ²–ç¹©å¡”å¯é£¯ï¼Œæ˜¯ç•¶åœ°çš„ä»£è¡¨æ€§å¹³åƒ¹ç¾é£Ÿã€‚" },
        { name: "åŠåºŠå’–å•¡", location: "ãƒãƒ³ãƒ¢ãƒƒã‚¯ã‚«ãƒ•ã‚§ ãƒ©ã‚¤ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰", type: "é¤é£²", day: 2, description: "åœ¨åŠåºŠä¸Šäº«å—å’–å•¡å’Œè¼•é£Ÿï¼Œæ˜¯æ”¾é¬†èº«å¿ƒçš„ç‰¹è‰²å’–å•¡å»³ã€‚" },
        { name: "æµ·æ™¯é¤å»³", location: "https://maps.app.goo.gl/9JMuu19PftCCJfXN7", type: "é¤é£²", day: 2, description: "æ“æœ‰çµ•ä½³æµ·æ™¯è¦–é‡çš„é¤å»³ï¼Œé©åˆé‚Šç”¨é¤é‚Šæ¬£è³æµ·æ™¯ã€‚" },
        { name: "çˆ¶è¦ªçš„é®ªé­š", location: "çˆ¶è¦ªçš„é®ªé­š æ²–ç¹©", type: "é¤é£²", day: 2, description: "ä¸»æ‰“æ–°é®®é®ªé­šæ–™ç†ï¼Œå¾ç”Ÿé­šç‰‡åˆ°å„ç¨®å‰µæ„é®ªé­šé¤é»ã€‚" },

        { name: "Lawson æ™‚ä»£å¤§å»ˆåº—", location: "Lawson æ™‚ä»£å¤§å»ˆåº—", type: "è³¼ç‰©", day: 3, description: "ä¾¿åˆ©å•†åº—æ¡è²·ï¼Œå¯è²·æ—©é¤å’Œé£²æ–™ï¼Œç‚ºåŒ—ä¸Šè·¯ç¨‹ä½œæº–å‚™ã€‚" },
        { name: "å¤å®‡åˆ©å³¶", location: "å¤å®‡åˆ©å³¶", type: "æ™¯é»", day: 3, description: "æœ‰è‘—æ¸…æ¾ˆæµ·æ°´å’Œç™½è‰²æ²™ç˜ï¼Œä»¥å¤å®‡åˆ©å¤§æ©‹èåçš„ç¾éº—æµ·å³¶ã€‚" },
        { name: "è¦è¦é£¯ (åˆé¤)", location: "è¦è¦é£¯ å¤å®‡åˆ©å³¶", type: "é¤é£²", day: 3, description: "é¤è»Šè²©å”®çš„å¤å¨å¤·é¢¨å‘³è’œè“‰è¦é£¯ï¼Œæ’éšŠäººæ°£ç¾é£Ÿã€‚" },
        { name: "ã—ã‚‰ã•é£Ÿå ‚ æµ·è†½è“‹é£¯", location: "https://maps.app.goo.gl/BbKDqGfKAExGjs1B8", type: "é¤é£²", day: 3, description: "ä»¥å¥¢è¯æµ·è†½è“‹é£¯å’Œæ–°é®®æµ·å‘³èåçš„åœ¨åœ°é£Ÿå ‚ã€‚" },
        { name: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨", location: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨", type: "æ™¯é»", day: 3, description: "å¿…è¨ªæ™¯é»ï¼æ“æœ‰å·¨å¤§ã€Œé»‘æ½®ä¹‹æµ·ã€æ°´æ§½å’Œè±å¯Œçš„æµ·æ´‹ç”Ÿç‰©å±•ç¤ºã€‚" },
        { name: "MaxValu ç‰§å¿—åº— (è¶…å¸‚)", location: "MaxValu ç‰§å¿—åº—", type: "è³¼ç‰©", day: 3, description: "ç•¶åœ°å¤§å‹è¶…å¸‚ï¼Œé©åˆè³¼è²·é›¶é£Ÿã€é£²æ–™å’Œå³æœŸç”Ÿé®®ã€‚" },
        
        { name: "åœ‹éš›é€š (æ¡è³¼)", location: "åœ‹éš›é€š æ²–ç¹©", type: "è³¼ç‰©", day: 4, description: "é‚£éœ¸æœ€ç†±é¬§çš„å•†åº—è¡—ï¼Œæ˜¯æ¡è³¼æ²–ç¹©ä¼´æ‰‹ç¦®çš„æœ€çµ‚ç«™ã€‚" },
        { name: "æ²–ç¸„ãã°ã‚¿ã‚¤ãƒ©è£½éººæ‰€ (åˆé¤)", location: "æ²–ç¸„ãã°ã‚¿ã‚¤ãƒ©è£½éººæ‰€ å›½éš›é€šã‚Šåº—", type: "é¤é£²", day: 4, description: "æä¾›æ­£å®—æ²–ç¹©éºµï¼Œéºµæ¢Qå½ˆï¼Œæ¹¯é ­æ¿ƒéƒã€‚" },
        { name: "SAN-Aæµ¦æ·»è¥¿æµ·å²¸ PARCO CITY", location: "https://maps.app.goo.gl/3TaAuTahx5D9uFKu6", type: "è³¼ç‰©", day: 4, description: "æ²–ç¹©æœ€å¤§å‹çš„æµ·æ™¯è³¼ç‰©ä¸­å¿ƒï¼Œæ“æœ‰ç„¡æ•µæµ·æ™¯èˆ‡çœ¾å¤šå“ç‰Œã€‚" },
        // START UPDATED ORIX LOCATION
        { name: "ORIXç§Ÿè»Š (ç¾æ „æ©‹ç«™å‰é‚„è»Š)", location: "https://maps.app.goo.gl/J88aLvqwCAerdvFY6", type: "äº¤é€š", day: 4, description: "ORIX ç¾æ „æ©‹ç«™å‰å¤–èªæ«ƒæª¯é‚„è»Šï¼Œé‚„è»Šå¾Œå¯æ­¥è¡Œè‡³è»Šç«™ï¼Œæ³¨æ„æ²¹ç®±æ˜¯å¦åŠ æ»¿ã€‚" },
        // END UPDATED ORIX LOCATION
        // DAY 4 æ–°å¢åœ°é»
        { name: "å¤§åœ‹è—¥å¦ (åœ‹éš›é€š)", location: "https://maps.app.goo.gl/yhQFhZm11fcjGumh9", type: "è³¼ç‰©", day: 4, description: "åœ‹éš›é€šä¸Šå—æ­¡è¿çš„è—¥å¦åº—ï¼Œé©åˆé›†ä¸­æ¡è³¼æ—¥ç”¨å“å’Œç¾å¦ã€‚" },
        { name: "æœ­å¹Œè—¥å¦ (åœ‹éš›é€š)", location: "https://maps.app.goo.gl/if7F5LfQeSkrSoFg6", type: "è³¼ç‰©", day: 4, description: "å¦ä¸€å®¶å¤§å‹è—¥å¦åº—ï¼Œå¯æ¯”åƒ¹å¾Œæ¡è³¼ã€‚" },
        { name: "å”å‰è¨¶å¾· (åœ‹éš›é€š)", location: "https://maps.app.goo.gl/8e5dtA7rYmAvkCyq9", type: "è³¼ç‰©", day: 4, description: "24å°æ™‚ç‡Ÿæ¥­çš„ç¶œåˆæŠ˜æ‰£å•†åº—ï¼Œå¾é£Ÿå“åˆ°é›»å™¨æ‡‰æœ‰ç›¡æœ‰ã€‚" },
        { name: "Blue Seal (åœ‹éš›é€š)", location: "https://maps.app.goo.gl/pgZJJHvgg3wrAaT37", type: "é¤é£²", day: 4, description: "æ²–ç¹©çš„åœ¨åœ°å†°æ·‡æ·‹å“ç‰Œï¼Œå£å‘³é¸æ“‡å¤šæ¨£ï¼Œé©åˆé£¯å¾Œç”œé»ã€‚" },
        { name: "æ²–ç¹©å±‹", location: "https://maps.app.goo.gl/LoTB6H6LPSC27PkW9", type: "è³¼ç‰©", day: 4, description: "å°ˆé–€è²©å”®æ²–ç¹©ç‰¹è‰²é›¶é£Ÿå’Œä¼´æ‰‹ç¦®çš„åº—é‹ªã€‚" },
        { name: "å¾¡è“å­å¾¡æ®¿ åœ‹éš›é€šç‰§å¿—åº—", location: "https://maps.app.goo.gl/9h4VYcwi6SoSVnHHA", type: "è³¼ç‰©", day: 4, description: "è³¼è²·ç´…è–¯è›‹å¡”ç­‰ç¶“å…¸æ²–ç¹©ç³•é»çš„æœ€ä½³åœ°é»ã€‚" },
    ];

    // --- UPDATED: Fixed Budget Items (åŒ…å«æ–°çš„æ—…å¹³éšªè²»ç”¨) ---
    const FIXED_BUDGET_ITEMS = [
        // äº¤é€šèˆ‡ä½å®¿ (å…±ç”¨)
        { name: "è™èˆªä¾†å›æ©Ÿç¥¨", category: "äº¤é€šèˆ‡ä½å®¿", amount: 7500, description: "å–®äººä¾†å›æ©Ÿç¥¨ NT$7,500", appliesTo: ['all'] },
        { name: "äº”å¤©å››å¤œä½å®¿", category: "äº¤é€šèˆ‡ä½å®¿", amount: 3608, description: "å–®äººä»½ä½å®¿åˆ†æ”¤è²»ç”¨ç¸½é¡", appliesTo: ['all'] }, 
        { name: "è‡ªé§•ç§Ÿè»Š", category: "äº¤é€šèˆ‡ä½å®¿", amount: 1285, description: "ç§Ÿè»Šè²»ç”¨ï¼ˆé ä¼°é‡‘é¡ï¼Œä»¥ç•¶æ—¥åŒ¯ç‡è¨ˆç®—ï¼‰", appliesTo: ['all'] }, // <<< è²»ç”¨å·²ä¿®æ­£ä¸¦å¢åŠ å‚™è¨»
        
        // æ¡è³¼èˆ‡é›œé …
        { name: "ç¶²å¡è²»ç”¨", category: "æ¡è³¼èˆ‡é›œé …", amount: 343, description: "æ²–ç¹©äº”æ—¥ç¶²è·¯è²»ç”¨", appliesTo: ['all'] },
        // UPDATED: æˆäººæ—…å¹³éšª (æŸè¨€ä½©çŠ, çˆ¸çˆ¸åª½åª½, æŸå»·å¹¼å¨œçš„æˆäºº)
        { name: "æ—…éŠå¹³å®‰éšª (æˆäºº)", category: "æ¡è³¼èˆ‡é›œé …", amount: 507, description: "å–®äººä»½æ—…è¡Œå¹³å®‰éšªè²»ç”¨ (æˆäºº NT$507/äºº)", appliesTo: ['æŸè¨€ä½©çŠ (è² è²¬äºº)', 'çˆ¸çˆ¸åª½åª½', 'æŸå»·å¹¼å¨œ'] },
        // NEW: å­©ç«¥æ—…å¹³éšª (æŸå»·å¹¼å¨œçš„å­©ç«¥)
        { name: "æ—…éŠå¹³å®‰éšª (å­©ç«¥)", category: "æ¡è³¼èˆ‡é›œé …", amount: 313, description: "å–®äººä»½æ—…è¡Œå¹³å®‰éšªè²»ç”¨ (å­©ç«¥ NT$313/äºº)", appliesTo: ['æŸå»·å¹¼å¨œ'] },
        
        // æ™¯é»é–€ç¥¨
        { name: "æ°´æ—é¤¨é–€ç¥¨ (æˆäºº)", category: "æ™¯é»èˆ‡å¨›æ¨‚", amount: 370, description: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨å–®äººæˆäººç¥¨", appliesTo: ['all'] }, 
        { name: "æ°´æ—é¤¨é–€ç¥¨ (å…’ç«¥)", category: "æ™¯é»èˆ‡å¨›æ¨‚", amount: 144, description: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨å–®äººå…’ç«¥ç¥¨", appliesTo: ['æŸå»·å¹¼å¨œ'] },
        
        // é«˜éµç¥¨ (å€‹åˆ¥è™•ç†)
        { name: "é«˜éµç¥¨ (å°å—â†’æ¡ƒåœ’)", category: "äº¤é€šèˆ‡ä½å®¿", amount: 1190, description: "å°å—åˆ°æ¡ƒåœ’å–®ç¨‹é«˜éµç¥¨ (æˆäººåƒ¹)", appliesTo: ['æŸè¨€ä½©çŠ (è² è²¬äºº)'] },
        { name: "é«˜éµç¥¨ (å˜‰ç¾©â†’æ¡ƒåœ’) - æˆäºº", category: "äº¤é€šèˆ‡ä½å®¿", amount: 920, description: "å˜‰ç¾©åˆ°æ¡ƒåœ’å–®ç¨‹é«˜éµç¥¨ (æˆäººåƒ¹)", appliesTo: ['çˆ¸çˆ¸åª½åª½', 'æŸå»·å¹¼å¨œ'] },
        { name: "é«˜éµç¥¨ (å˜‰ç¾©â†’æ¡ƒåœ’) - å­©ç«¥", category: "äº¤é€šèˆ‡ä½å®¿", amount: 460, description: "å˜‰ç¾©åˆ°æ¡ƒåœ’å–®ç¨‹é«˜éµç¥¨ (å­©ç«¥åƒ¹)", appliesTo: ['æŸå»·å¹¼å¨œ'] },
    ];
    
    // Initial Data Structure for common packing items
    const initialCommonPackingList = [
        { name: "è­·ç…§ã€å…¥å¢ƒè¡¨", category: "document", luggage: "éš¨èº«è¡Œæ", packed: false, description: "æ—…è¡Œå¿…å‚™ï¼" },
        { name: "æ©Ÿç¥¨ã€å°ç£é§•ç…§ã€åœ‹éš›é§•ç…§", category: "document", luggage: "éš¨èº«è¡Œæ", packed: false, description: "é›»å­æˆ–ç´™æœ¬å‚™ä»½" },
        { name: "å¤–å¹£ / ä¿¡ç”¨å¡", category: "document", luggage: "éš¨èº«è¡Œæ", packed: false, description: "" },
        
        { name: "å¤–å¥— / ä¿æš–è¡£ç‰©", category: "clothing", luggage: "éš¨èº«è¡Œæ / æ‰˜é‹", packed: false, description: "æ‡‰å°æ—©æ™šæº«å·®" },
        { name: "æ›æ´—è¡£ç‰©/è²¼èº«è¡£ç‰© ", category: "clothing", luggage: "æ‰˜é‹", packed: false, description: "" },
        
        { name: "ç›¥æ´—ç”¨å“ (100mlä»¥ä¸Š)", category: "hygiene", luggage: "æ‰˜é‹", packed: false, description: "æ³¨æ„ï¼šæ¶²é«”å®¹é‡é™åˆ¶" },
        { name: "å¸¸å‚™è—¥å“ (æ„Ÿå†’è—¥/èƒƒè—¥)", category: "hygiene", luggage: "éš¨èº«è¡Œæ", packed: false, description: "å»ºè­°ä¿ç•™åŸåŒ…è£" },
        
        { name: "è¡Œå‹•é›»æº (å¿…éš¨èº«)", category: "electronics", luggage: "éš¨èº«è¡Œæ", packed: false, description: "**å¿…é ˆ**éš¨èº«æ”œå¸¶ï¼Œä¸å¯æ‰˜é‹ï¼" },
    ];
    
    // --- è¡Œç¨‹æè¿° (Itinerary details are static) ---
    const initialItineraryData = {
        itinerary_title: "æ²–ç¹©äº”å¤©å››å¤œæ—…éŠè¡Œç¨‹è¡¨",
        
        flights: {
            outbound: {
                airline: "tigersmart",
                flight_number: "IT232",
                departure: "TPE æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ ",
                departure_time: "2025-12-21 18:20 PM",
                arrival: "OKA æ²–ç¹©é‚£éœ¸æ©Ÿå ´",
                arrival_time: "2025-12-21 20:40 PM"
            },
            return: {
                airline: "tigersmart",
                flight_number: "IT797",
                departure: "OKA æ²–ç¹©é‚£éœ¸æ©Ÿå ´",
                departure_time: "2025-12-25 13:30 PM",
                arrival: "TNN å°å—æ©Ÿå ´",
                arrival_time: "2025-12-25 14:20 PM"
            }
        },

        itinerary_details: [
            { 
                day: 1, 
                date: "12/21 (æ—¥)", 
                time_range: "18:20 PM - æ™šé–“",
                title: "æ™šç­æ©ŸæŠµé” / é£¯åº—ä¼‘æ¯", 
                description_items: [
                    
                    "èˆªç­ IT232 (18:20 PM) æŠµé” OKA æ²–ç¹©é‚£éœ¸æ©Ÿå ´ (20:40 PM)ã€‚",
                    "å‰å¾€å…¥ä½é£¯åº—ï¼š2-chÅme-1-15 Kumoji ä¹…èŒ‚åœ°ç¬¬ä¸€ãƒ“ãƒ« ï¼“éšã€‚"
                ],
                notes_items: [
                    "æ™šé¤ï¼šæ©Ÿå ´æˆ–é£¯åº—é™„è¿‘è‡ªç†"
                ]
            },
            { 
                day: 2, 
                date: "12/22 (ä¸€)", 
                time_range: "08:30 - 20:00",
                title: "æµ·é®®å¸‚å ´èˆ‡ç¾åœ‹æ‘", 
                description_items: [
                    // UPDATED
                    "08:00 ORIXç§Ÿè»Š (ç¾æ „æ©‹ç«™å‰å¤–èªæ«ƒæª¯) å–è»Šï¼Œæº–å‚™å‡ºç™¼ã€‚",
                    "08:30 - 11:00 ç¬¬ä¸€ç‰§å¿—å…¬è¨­å¸‚å ´ ã€‚",
                    "11:40 - 13:00 ç€¨é•·å³¶ã€‚",
                    "13:40 - 15:30 ç¾åœ‹æ‘ ã€‚",
                    "18:30 - 20:00 æ™šé¤ï¼šç‚­ç«ç„¼è‚‰ã¶ã¡ä¹…èŒ‚åœ°åº— (å·²è¨‚ä½ 18:40)ã€‚"
                ],
                notes_items: [
                    "æ—©é¤æ¨è–¦ï¼šPork Tamago Onigiri Makishi Marketè±¬è‚‰è›‹åå¸ã€‚",
                    "å‰å¾€ç¾åœ‹æ‘è»Šç¨‹ç´„35åˆ†é˜ã€‚",
                    "ç€¨é•·å³¶é¤é»å¯åƒè€ƒï¼šå¹¸ç¦é¬†é¤…ã€æ°¾æ¿«æ¼¢å ¡ã€çˆ¶è¦ªçš„é®ªé­šç­‰ã€‚"
                ]
            },
            { 
                day: 3, 
                date: "12/23 (äºŒ)", 
                time_range: "08:00 - 18:00",
                title: "å¤å®‡åˆ©å³¶èˆ‡ç¾éº—æµ·æ°´æ—é¤¨", 
                description_items: [
                    "08:00 Lawson æ™‚ä»£å¤§å»ˆåº—ä¾¿åˆ©å•†åº—æ¡è³¼ã€‚",
                    "09:30 - 11:00 å¤å®‡åˆ©å³¶ ã€‚",
                    "11:30 - 15:30 æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨ (å·²è¨‚ç¥¨)ã€‚",
                    "17:00 MaxValu ç‰§å¿—åº—è¶…å¸‚æ¡è³¼ã€‚",
                    "18:00 è¿”å›é£¯åº—ã€‚"
                ],
                notes_items: [
                    "å»å¤å®‡åˆ©å³¶è»Šç¨‹ç´„1.5å°æ™‚ã€‚",
                    "åˆé¤æ¨è–¦ï¼šè¦è¦é£¯ æˆ– ã—ã‚‰ã•é£Ÿå ‚ æµ·è†½è“‹é£¯ã€‚",
                    "æ°´æ—é¤¨ï¼šæµ·è±šç§€ (13:00)é¯¨é¯Šé¤µé£Ÿç§€ (15:00)ã€‚"
                ]
            },
            { 
                day: 4, 
                date: "12/24 (ä¸‰)", 
                time_range: "09:30 - 17:30",
                title: "ä¼´æ‰‹ç¦®è¡€æ‹¼ & PARCO CITY", 
                description_items: [
                    "09:30 - 11:30 åœ‹éš›é€šä¼´æ‰‹ç¦®æ¡è²· ã€‚",
                    "11:30 - 13:00 åœ‹éš›é€šåˆé¤ã€‚",
                    "13:30 - 16:30 SAN-Aæµ¦æ·»è¥¿æµ·å²¸ PARCO CITYã€‚",
                    // UPDATED
                    "17:30 å‰å¾€ ORIXç§Ÿè»Š (ç¾æ „æ©‹ç«™å‰å¤–èªæ«ƒæª¯) é‚„è»Šã€‚"
                ],
                notes_items: [
                    "æ™šé¤ï¼šé‚„è»Šå¾Œè‡ªç†ã€‚",
                    "åˆé¤æ¨è–¦ï¼šæ²–ç¸„ãã°ã‚¿ã‚¤ãƒ©è£½éººæ‰€ã€‚"
                ]
            },
            { 
                day: 5, 
                date: "12/25 (å››)", 
                time_range: "æ—©ä¸Š",
                title: "æ­æ©Ÿå›ç¨‹", 
                description_items: [
                    "é ç•™æ¯”å¹³å¸¸æ›´å¤šæ™‚é–“å‰å¾€æ©Ÿå ´ã€‚",
                    "å›ç¨‹èˆªç­ IT797 (13:30 PM èµ·é£›) é£›å¾€ TNN å°å—æ©Ÿå ´ (14:20 PM æŠµé”)ã€‚"
                ],
                notes_items: [
                    "éœ€åœ¨ 11:00 å·¦å³æŠµé”æ²–ç¹©é‚£éœ¸æ©Ÿå ´ (OKA) è¾¦ç†æ‰‹çºŒã€‚",
                ]
            },
        ],
        
        // Packing list structured by traveler name (static)
        packing_lists: {
            'æŸè¨€ä½©çŠ (è² è²¬äºº)': [
                ...initialCommonPackingList,
                { name: "DJI ç›¸æ©Ÿ ", category: "electronics", luggage: "éš¨èº«è¡Œæ", packed: false, description: "ç¢ºèªé›»æ± å……é£½ã€‚" },
            ],
            'çˆ¸çˆ¸åª½åª½': [
                ...initialCommonPackingList,
                { name: "é ¸æ• / çœ¼ç½© / è€³å¡", category: "hygiene", luggage: "éš¨èº«è¡Œæ", packed: false, description: "æ©Ÿä¸ŠåŠè»Šä¸Šä¼‘æ¯ç”¨" },
            ],
            'æŸå»·å¹¼å¨œ': [
                ...initialCommonPackingList,
                { name: "å…’ç«¥é†«è—¥åŒ… (é€€ç‡’è—¥ã€OKç¹ƒ)", category: "hygiene", luggage: "éš¨èº«è¡Œæ", packed: false, description: "å…’ç«¥å°ˆç”¨è—¥å“" },
            ]
        },

        // Budget Structure
        fixed_items: FIXED_BUDGET_ITEMS, 
        
        expense_tracker: { // æ¯å€‹æ—…ä¼´çš„è¨˜å¸³ç´€éŒ„
            'æŸè¨€ä½©çŠ (è² è²¬äºº)': [],
            'çˆ¸çˆ¸åª½åª½': [],
            'æŸå»·å¹¼å¨œ': []
        },

        map_locations: map_locations_data, 

        lastUpdated: new Date().toISOString()
    };

    // --- Utility Functions ---

    // Packing List Mapping
    const packingCategoryMap = {
        'document': 'æ–‡ä»¶èˆ‡é‡‘è', 'clothing': 'è¡£ç‰©èˆ‡é…ä»¶', 'hygiene': 'ç›¥æ´—èˆ‡è—¥å“', 'electronics': 'é›»å­èˆ‡é›œé …'
    };
    // UPDATED: Use more consistent colors
    const packingCategoryColor = {
        'document': 'text-cyan-700', 'clothing': 'text-purple-700', 'hygiene': 'text-teal-700', 'electronics': 'text-orange-700'
    };
    
    // Budget Category Colors (Fixed and Variable)
    const budgetCategoryColor = {
        'äº¤é€šèˆ‡ä½å®¿': 'border-cyan-400 bg-cyan-50', // Fixed (Cyan)
        'æ™¯é»èˆ‡å¨›æ¨‚': 'border-teal-400 bg-teal-50', // Fixed (Teal)
        
        // Variable Expenses (Orange/Yellow/Green)
        'é¤é£²èˆ‡é›¶é£Ÿ': 'border-red-400 bg-red-50', 
        'è³¼ç‰©èˆ‡ç´€å¿µå“': 'border-pink-400 bg-pink-50',
        'äº¤é€šèˆ‡æ²¹è²»': 'border-yellow-400 bg-yellow-50',
        'æ™¯é»èˆ‡å¨›æ¨‚ (è‡¨è³¼)': 'border-green-400 bg-green-50',
        'æ¡è³¼èˆ‡é›œé …': 'border-pink-400 bg-pink-50',
        'å…¶ä»–': 'border-gray-400 bg-gray-50'
    };


    // Map Location Tag Colors
    const locationTypeColor = {
        'ä½å®¿': 'bg-red-100 text-red-800',
        'äº¤é€š': 'bg-cyan-100 text-cyan-800',
        'æ™¯é»': 'bg-emerald-100 text-emerald-800',
        'é¤é£²': 'bg-yellow-100 text-yellow-800',
        'è³¼ç‰©': 'bg-blue-100 text-blue-800',
    };

    /**
     * Copies the element's text content to the clipboard. (Disabled after ID block removal)
     */
    window.copyToClipboard = (elementId) => {
        // Function no longer needed since ID block is removed, but kept as a stub if needed later.
        console.log("Copy to clipboard functionality is disabled.");
    }

    /**
     * Opens Google Maps search for the given query, adding "æ²–ç¹©" for context, OR opens a direct link.
     */
    window.openMap = (query) => {
        if (query.startsWith('http://') || query.startsWith('https://')) {
            window.open(query, '_blank');
        } else {
            const fullQuery = encodeURIComponent(query + " æ²–ç¹©");
            const url = `https://www.google.com/maps/search/?api=1&query=${fullQuery}`;
            window.open(url, '_blank');
        }
    };
    
    /**
     * Sets the active traveler for the packing list/budget view.
     */
    window.selectTraveler = (travelerName) => {
        currentSelectedTraveler = travelerName;
        renderUserSelector(); // Re-render selector to highlight active user
        
        if (currentActiveTab === 'packing') {
            if (currentItineraryData) {
                renderPackingList(currentItineraryData.packing_lists[currentSelectedTraveler] || []);
            }
        } else if (currentActiveTab === 'budget') {
            if (currentItineraryData) {
                renderBudget(currentItineraryData.fixed_items, currentItineraryData.expense_tracker[currentSelectedTraveler] || []);
            }
        } else {
            showTab('packing');
        }
    }


    /**
     * Switches between the 'itinerary', 'packing', 'budget', and 'map' tabs.
     */
    window.showTab = (tabName) => {
        currentActiveTab = tabName; // Update active tab tracker
        
        const views = {
            itinerary: document.getElementById('itineraryDetailView'),
            map: document.getElementById('mapView'),
            packing: document.getElementById('packingListView'),
            budget: document.getElementById('budgetView')
        };
        const tabs = {
            itinerary: document.getElementById('tabItinerary'),
            map: document.getElementById('tabMap'),
            packing: document.getElementById('tabPacking'),
            budget: document.getElementById('tabBudget')
        };
        
        // Toggle the visibility of the user selector based on the tab
        const userSelectorContainer = document.getElementById('user-selector-container');
        if (tabName === 'packing' || tabName === 'budget') {
            userSelectorContainer.classList.remove('hidden');
            renderUserSelector();
        } else {
            userSelectorContainer.classList.add('hidden');
        }

        Object.values(views).forEach(v => v.classList.add('hidden'));
        Object.values(tabs).forEach(t => t.classList.remove('tab-active', 'text-gray-900'));
        Object.values(tabs).forEach(t => t.classList.add('text-gray-500'));


        views[tabName].classList.remove('hidden');
        tabs[tabName].classList.add('tab-active');
        tabs[tabName].classList.remove('text-gray-500');
        tabs[tabName].classList.add('text-gray-900');
        
        // When switching to map/budget/packing view, ensure the content is rendered
        if (currentItineraryData) {
            if (tabName === 'map') {
                renderMapLocations(currentItineraryData.map_locations);
            } else if (tabName === 'packing') {
                renderPackingList(currentItineraryData.packing_lists[currentSelectedTraveler] || []);
            } else if (tabName === 'budget') {
                renderBudget(currentItineraryData.fixed_items, currentItineraryData.expense_tracker[currentSelectedTraveler] || []);
            }
        }
    };


    // --- Firestore Update Handlers (Packing List, Expense Tracker) ---

    /**
     * Toggles the 'packed' status of an item in the *current selected traveler's* packing list.
     */
    window.togglePacked = async (index) => {
        if (!isAuthReady || !userId || !currentSelectedTraveler) {
            console.error("Authentication not ready or traveler not selected. Cannot update item.");
            return;
        }
        await updatePackingStatus(currentSelectedTraveler, index);
    };

    /**
     * Updates the 'packed' status of an item for a specific traveler.
     */
    async function updatePackingStatus(travelerName, index) {
        const docRef = getItineraryDocRef();
        if (!docRef) return;

        try {
            const docSnapshot = await getDoc(docRef);
            if (!docSnapshot.exists()) return;
            
            const data = docSnapshot.data();
            const lists = data['packing_lists'];

            if (lists && lists[travelerName] && lists[travelerName][index]) {
                const list = lists[travelerName];
                const newStatus = !list[index]['packed'];
                list[index]['packed'] = newStatus;
                
                // Construct the dynamic field path for the update
                const updatePayload = {
                    [`packing_lists.${travelerName}`]: list,
                    lastUpdated: new Date().toISOString()
                };

                await updateDoc(docRef, updatePayload);
                console.log(`Packing list item for ${travelerName} at index ${index} toggled to ${newStatus}`);
            }
        } catch (error) {
            console.error(`Error updating packing status:`, error);
        }
    }
    
    /**
     * 1. æ–°å¢è¨˜å¸³é …ç›®
     */
    window.addExpense = async (event) => {
        event.preventDefault();
        
        if (!isAuthReady || !userId || !currentSelectedTraveler) {
            console.error("Authentication not ready or traveler not selected. Cannot add expense.");
            return;
        }

        const descriptionInput = document.getElementById('expenseDescription');
        const amountInput = document.getElementById('expenseAmount');
        const categoryInput = document.getElementById('expenseCategory');
        // NEW: Get payment method
        const paymentMethodInput = document.querySelector('input[name="paymentMethod"]:checked');
        const addBtn = document.getElementById('addExpenseBtn');

        const description = descriptionInput.value.trim();
        // The amount is always stored as an integer, regardless of the display currency (JPY in this case)
        const amount = parseInt(amountInput.value, 10);
        const category = categoryInput.value;
        const paymentMethod = paymentMethodInput ? paymentMethodInput.value : 'ç¾é‡‘'; // Default to Cash
        
        if (description === '' || isNaN(amount) || amount <= 0) {
            console.error("Invalid expense input.");
            return;
        }
        
        addBtn.disabled = true;
        addBtn.textContent = 'å„²å­˜ä¸­...';

        const docRef = getItineraryDocRef();
        if (!docRef) {
             addBtn.disabled = false;
             addBtn.textContent = 'æ–°å¢è¨˜å¸³';
             return;
        }

        try {
            const docSnapshot = await getDoc(docRef);
            if (!docSnapshot.exists()) return;
            
            const data = docSnapshot.data();
            const tracker = data['expense_tracker'] || {};
            const travelerList = tracker[currentSelectedTraveler] || [];
            
            const newExpense = {
                id: Date.now().toString(), // Use timestamp for unique ID (better than index for deletion)
                name: description,
                amount: amount,
                category: category,
                paymentMethod: paymentMethod, // Store payment method
                date: new Date().toISOString().substring(0, 10) // YYYY-MM-DD
            };
            
            travelerList.push(newExpense);
            
            // Construct the dynamic field path for the update
            const updatePayload = {
                [`expense_tracker.${currentSelectedTraveler}`]: travelerList,
                lastUpdated: new Date().toISOString()
            };

            await updateDoc(docRef, updatePayload);
            console.log(`Expense added for ${currentSelectedTraveler}`);
            
            // Reset form
            descriptionInput.value = '';
            amountInput.value = '';
            // Reset radio to default (Cash)
            document.querySelector('input[name="paymentMethod"][value="ç¾é‡‘"]').checked = true;

        } catch (error) {
            console.error(`Error adding expense:`, error);
        } finally {
            addBtn.disabled = false;
            addBtn.textContent = 'æ–°å¢è¨˜å¸³';
        }
    }
    
    /**
     * 2. åˆªé™¤è¨˜å¸³é …ç›®
     */
    window.deleteExpense = async (expenseId) => {
        if (!isAuthReady || !userId || !currentSelectedTraveler) {
            console.error("Authentication not ready or traveler not selected. Cannot delete expense.");
            return;
        }

        const docRef = getItineraryDocRef();
        if (!docRef) return;
        
        try {
            const docSnapshot = await getDoc(docRef);
            if (!docSnapshot.exists()) return;
            
            const data = docSnapshot.data();
            const tracker = data['expense_tracker'] || {};
            const travelerList = tracker[currentSelectedTraveler] || [];
            
            const updatedList = travelerList.filter(item => item.id !== expenseId);
            
            // Construct the dynamic field path for the update
            const updatePayload = {
                [`expense_tracker.${currentSelectedTraveler}`]: updatedList,
                lastUpdated: new Date().toISOString()
            };

            await updateDoc(docRef, updatePayload);
            console.log(`Expense with ID ${expenseId} deleted for ${currentSelectedTraveler}`);
            
        } catch (error) {
            console.error(`Error deleting expense:`, error);
        }
    }


    // --- Rendering Functions ---
    
    /**
     * Renders the user selector tags.
     */
    function renderUserSelector() {
        const selectorDiv = document.getElementById('userSelector');
        let html = '';
        
        TRAVELER_NAMES.forEach(name => {
            const isActive = name === currentSelectedTraveler;
            const activeClass = isActive ? 'user-tag-active' : 'bg-gray-200 text-gray-700 hover:bg-gray-300';
            // UPDATED: Use simple text icon
            const icon = name.includes('(è² è²¬äºº)') ? 'è² è²¬äºº' : 'æ—…ä¼´';
            
            // Only display the name part without '(è² è²¬äºº)' in the button
            const displayName = name.replace(' (è² è²¬äºº)', '');

            html += `
                <span 
                    class="user-tag text-sm font-semibold py-2 px-4 rounded-full flex-shrink-0 ${activeClass}" 
                    onclick="selectTraveler('${name.replace(/'/g, "\\'")}')"
                >
                    ${icon} ${displayName}
                </span>
            `;
        });
        selectorDiv.innerHTML = html;
        
        // Update the message for the current active tab
        if (currentActiveTab === 'packing') {
            document.getElementById('packingListUserMessage').innerHTML = `
                æ‚¨æ­£åœ¨æª¢è¦–çš„æ˜¯ **${currentSelectedTraveler.replace(' (è² è²¬äºº)', '')}** çš„å€‹äººæ‰“åŒ…æ¸…å–®ã€‚
            `;
        } else if (currentActiveTab === 'budget') {
            document.getElementById('budgetTravelerMessage').innerHTML = `
                <p class="text-sm font-semibold mb-4 bg-cyan-50 p-3 rounded-lg border-l-4 border-cyan-400 text-cyan-800">
                    æ‚¨æ­£åœ¨æª¢è¦–çš„æ˜¯ **${currentSelectedTraveler.replace(' (è² è²¬äºº)', '')}** çš„å›ºå®šè²»ç”¨èˆ‡è®Šå‹•è¨˜å¸³ã€‚
                </p>
            `;
        }
    }
    
    /**
     * Renders a single flight segment (outbound or return).
     */
    function renderFlightSegment(segment, type) {
        // UPDATED: Use text instead of emoji
        const icon = type === 'outbound' ? 'å‡ºç™¼' : 'æŠµé”';
        const direction = type === 'outbound' ? 'å»ç¨‹' : 'å›ç¨‹';
        const bgClass = type === 'outbound' ? 'bg-cyan-100 border-cyan-300' : 'bg-teal-100 border-teal-300';
        
        return `
            <div class="flight-card rounded-lg p-3 mb-2 ${bgClass}">
                <div class="flex items-center justify-between mb-2 border-b border-dashed pb-1">
                    <span class="text-sm font-bold text-gray-700">${icon} ${direction} (${segment.airline})</span>
                    <span class="text-xs font-semibold text-gray-600">èˆªç­è™Ÿç¢¼: ${segment.flight_number}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <div>
                        <p class="font-bold text-gray-800">${segment.departure}</p>
                        <p class="text-xs text-gray-500 whitespace-nowrap">${segment.departure_time}</p>
                    </div>
                    <div class="text-center text-gray-600 self-center">
                        <span class="font-bold">â†’</span>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-800">${segment.arrival}</p>
                        <p class="text-xs text-gray-500 whitespace-nowrap">${segment.arrival_time}</p>
                    </div>
                </div>
            </div>
        `;
    }

    /**
     * Renders array of strings into a bulleted list.
     */
    function renderListItems(items) {
        if (!items || items.length === 0) return '';
        const listItems = items.map(item => `<li class="mb-1">${item}</li>`).join('');
        return `<ul class="list-disc pl-5 text-sm space-y-1">${listItems}</ul>`;
    }

    /**
     * Renders the itinerary details from the provided data.
     */
    function renderItineraryDetails(details, flights) {
        const contentDiv = document.getElementById('itineraryDetailContent');
        if (!details || details.length === 0) {
            contentDiv.innerHTML = '<p class="text-center text-gray-500 py-10">è¡Œç¨‹ç´°ç¯€ç‚ºç©ºã€‚</p>';
            return;
        }

        let html = '';
        
        // 1. Render Flight Summary
        if (flights) {
            // UPDATED: Use text instead of emoji
            html += `<h2 class="text-xl font-bold text-cyan-700 mb-3">èˆªç­è³‡è¨Šç¸½è¦½</h2>`;
            html += renderFlightSegment(flights.outbound, 'outbound');
            html += renderFlightSegment(flights.return, 'return');
            html += `<h2 class="text-xl font-bold text-cyan-700 mt-6 mb-3">æ¯æ—¥è©³ç´°è¡Œç¨‹</h2>`;
        }

        // 2. Render Daily Details
        details.forEach(detail => {
            const notesIcon = 'å‚™è¨»:'; // UPDATED: Use text instead of emoji
            html += `
                <div class="itinerary-card bg-cyan-50 rounded-xl p-4 flex items-center mt-4 border border-cyan-200">
                    <!-- Day Marker -->
                    <div class="flex flex-col items-center mr-4 flex-shrink-0 w-16">
                        <div class="text-3xl font-extrabold text-cyan-600 leading-none whitespace-nowrap">Day ${detail.day}</div>
                        <div class="text-xs text-gray-600 whitespace-nowrap">${detail.date}</div>
                    </div>
                    <!-- Details -->
                    <div class="flex-grow min-w-0">
                        <!-- Time Range -->
                        <div class="text-sm font-semibold text-gray-800 mb-2 border-b border-cyan-200 pb-1">
                             <span class="text-cyan-600 font-bold">æ™‚æ®µ:</span> <span class="whitespace-nowrap">${detail.time_range}</span>
                        </div>
                        
                        <div class="text-lg font-bold text-gray-900 leading-snug mb-2">
                            ${detail.title}
                        </div>
                        
                        <!-- Description as Bulleted List -->
                        <div class="text-sm text-gray-700 mt-2 border-l-2 border-amber-500 pl-2">
                            ${renderListItems(detail.description_items)}
                        </div>
                        
                        <!-- Notes as Bulleted List -->
                        ${detail.notes_items && detail.notes_items.length > 0 ? `
                            <div class="text-xs text-amber-700 bg-amber-100 p-2 rounded mt-3">
                                <p class="font-bold mb-1">${notesIcon}</p>
                                ${renderListItems(detail.notes_items)}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });
        html += `<div class="text-center pt-4 pb-10 text-gray-500 text-sm">--- è¡Œç¨‹çµæŸ ---</div>`;
        contentDiv.innerHTML = html;
        document.getElementById('loadingIndicator').classList.add('hidden');
    }

    /**
     * Renders the dedicated Map Navigation list.
     */
    function renderMapLocations(locations) {
        const contentDiv = document.getElementById('mapContent');
        if (!locations || locations.length === 0) {
            contentDiv.innerHTML = '<p class="text-center text-gray-500 py-10">åœ°åœ–åœ°é»æ¸…å–®ç‚ºç©ºã€‚</p>';
            return;
        }

        const groupedLocations = locations.reduce((acc, item) => {
            const day = item.day;
            if (!acc[day]) acc[day] = [];
            acc[day].push(item);
            return acc;
        }, {});

        let html = '';
        
        for (const day in groupedLocations) {
            html += `
                <div class="space-y-3 mb-8">
                    <h2 class="text-2xl font-extrabold text-cyan-600 border-b-2 border-cyan-400 pb-2">
                        Day ${day}
                    </h2>
            `;
            
            groupedLocations[day].forEach(item => {
                const tagClass = locationTypeColor[item.type] || 'bg-gray-100 text-gray-700';
                const mapQuery = item.location.replace(/'/g, "\\'");
                
                const displayLocation = (item.location.startsWith('http') || item.location.startsWith('https')) 
                                        ? 'é»æ“Šå°èˆªé–‹å•Ÿé€£çµ' 
                                        : item.location;

                html += `
                    <div class="list-item-card bg-white rounded-lg p-4 flex items-center justify-between border-l-4 border-cyan-200">
                        <div class="flex-grow min-w-0 pr-2">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="text-sm font-bold text-gray-900 truncate">${item.name}</span>
                                <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${tagClass} flex-shrink-0">${item.type}</span>
                            </div>
                            <div class="text-sm text-gray-700 italic mt-1 leading-snug">${item.description || 'ç„¡ç‰¹è‰²èªªæ˜ã€‚'}</div> 
                            <div class="text-xs text-gray-400 mt-1 truncate">åœ°é»ä»£ç¢¼/é€£çµï¼š${displayLocation}</div>
                        </div>
                        <button onclick="openMap('${mapQuery}')" class="flex items-center text-sm bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-full shadow-md transition duration-150 flex-shrink-0 ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-1">
                                <path d="M10.865 3.027a2.5 2.5 0 0 0-3.73 0l-5.188 7.643A4.5 4.5 0 0 0 5.485 18.5h9.03a4.5 4.5 0 0 0 3.553-7.83L10.865 3.027ZM13 14a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm-4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm-.5-5.967a.999.999 0 0 1 1.996 0A7.545 7.545 0 0 0 10 12.5a.75.75 0 0 1 1.5 0 9.045 9.045 0 0 1-3.04-5.467Z" />
                            </svg>
                            å°èˆª
                        </button>
                    </div>
                `;
            });

            html += `</div>`;
        }

        contentDiv.innerHTML = html;
    }

    /**
     * Helper: Calculates the fixed budget for a specific traveler based on the FIXED_BUDGET_ITEMS rules.
     */
    function getTravelerFixedExpenses(travelerName, fixedItems) {
        // Filter items applicable to this traveler (using appliesTo array)
        const applicableItems = fixedItems.filter(item => 
            item.appliesTo.includes('all') || item.appliesTo.includes(travelerName)
        );
        
        const groupedFixed = applicableItems.reduce((acc, item) => {
            const category = item.category;
            if (!acc[category]) acc[category] = [];
            
            let calculatedAmount = item.amount;
            let multiplier = 1; // Start with 1
            const itemName = item.name;

            // --- UPDATED CUSTOM MULTIPLIER LOGIC based on user request ---
            
            if (travelerName === 'æŸè¨€ä½©çŠ (è² è²¬äºº)' || travelerName === 'çˆ¸çˆ¸åª½åª½') {
                // Rule 1: All costs are multiplied by 2 for these two groups.
                multiplier = 2;
            } else if (travelerName === 'æŸå»·å¹¼å¨œ') {
                // Rule 2: æŸå»·å¹¼å¨œ is a mixed case.
                if (itemName === 'è™èˆªä¾†å›æ©Ÿç¥¨') {
                    // Rule 2a: æ©Ÿç¥¨ is 2 person-portions (x2)
                    multiplier = 2;
                } else {
                    // Rule 2b: Other items are 1 person-portion (x1) - default 1 holds true
                    multiplier = 1; 
                }
            }
            // --- END UPDATED CUSTOM MULTIPLIER LOGIC ---

            calculatedAmount *= multiplier;

            acc[category].push({ 
                ...item, 
                amount: calculatedAmount, // Overwrite amount with the calculated value
                originalAmount: item.amount, // Keep original unit amount
                multiplier: multiplier
            });
            return acc;
        }, {});
        
        return groupedFixed;
    }

    /**
     * Renders the UPDATED Budget View (Fixed Summary + Tracked Expenses List).
     */
    function renderBudget(fixedItems, trackedExpenses) {
        const fixedDiv = document.getElementById('fixedExpensesSummary');
        const trackedDiv = document.getElementById('trackedExpensesList');
        
        if (!currentSelectedTraveler || !fixedItems || !trackedExpenses) return;

        // --- 1. Render Fixed Expenses Summary (Currency: NT$) ---
        const groupedFixed = getTravelerFixedExpenses(currentSelectedTraveler, fixedItems);
        let fixedHtml = '';
        let totalFixedBudgeted = 0;

        fixedHtml += `<h2 class="text-xl font-bold text-cyan-700 mt-2 mb-4">${currentSelectedTraveler.replace(' (è² è²¬äºº)', '')} å·²é ä»˜é …ç›® - NT$</h2>`;

        for (const [categoryKey, items] of Object.entries(groupedFixed)) {
            const titleColor = budgetCategoryColor[categoryKey] || 'border-gray-400 bg-gray-50';

            fixedHtml += `
                <div class="space-y-2 mb-4">
                    <h3 class="text-base font-semibold text-gray-700 border-b border-gray-300 pb-1">
                        ${categoryKey}
                    </h3>
            `;

            items.forEach(item => {
                totalFixedBudgeted += item.amount;
                
                // Only show multiplier info if it is greater than 1
                const multiplierInfo = item.multiplier > 1 ? 
                    `<div class="text-xs text-orange-500 font-medium">NT$${item.originalAmount.toLocaleString()} x ${item.multiplier} ä»½ (å…©äºº)</div>` : '';
                
                fixedHtml += `
                    <div class="fixed-budget-card bg-white rounded-lg p-3 flex items-center justify-between border-l-4 border-cyan-700">
                        <div class="flex-grow">
                            <div class="text-sm font-semibold text-gray-900 leading-snug">${item.name}</div>
                            <div class="text-xs text-gray-500">${item.description}</div>
                            ${multiplierInfo}
                        </div>
                        <div class="flex-shrink-0 ml-4 text-right">
                            <div class="text-base font-extrabold text-cyan-700 whitespace-nowrap">
                                NT$ ${item.amount.toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            fixedHtml += `</div>`;
        }

        // Fixed Summary Card (Removed emoji)
        const fixedSummaryHtml = `
            <div class="total-summary-card bg-cyan-700 text-white rounded-xl p-4 mb-6 shadow-xl">
                <div class="text-sm font-semibold mb-1"> ${currentSelectedTraveler.replace(' (è² è²¬äºº)', '')} å›ºå®šé ä»˜ç¸½é¡ </div>
                <div class="flex justify-between items-center">
                    <span class="text-xl font-bold">ç¸½è¨ˆ:</span>
                    <span class="text-2xl font-extrabold text-yellow-300">NT$ ${totalFixedBudgeted.toLocaleString()}</span>
                </div>
            </div>
        `;
        fixedDiv.innerHTML = fixedSummaryHtml + fixedHtml;


        // --- 2. Render Tracked Expenses List (Currency: JPYÂ¥) ---
        let trackedHtml = '';
        let totalTrackedExpense = 0;

        // UPDATED: Use text instead of emoji
        trackedHtml += `<h2 class="text-xl font-bold text-orange-600 mt-6 mb-4 border-t pt-4"> ${currentSelectedTraveler.replace(' (è² è²¬äºº)', '')} è®Šå‹•èŠ±è²»è¨˜å¸³ (JPYÂ¥)</h2>`;
        
        if (trackedExpenses.length === 0) {
            trackedHtml += '<p class="text-center text-gray-500 py-6 bg-gray-100 rounded-lg">å°šç„¡è®Šå‹•èŠ±è²»ç´€éŒ„ã€‚</p>';
        } else {
            // Sort by latest (newest first)
            const sortedExpenses = [...trackedExpenses].sort((a, b) => b.id - a.id);
            
            sortedExpenses.forEach(item => {
                totalTrackedExpense += item.amount;
                const categoryClass = budgetCategoryColor[item.category] || 'border-gray-400 bg-gray-50';
                
                // NEW: Payment Method Badge Logic
                const paymentMethod = item.paymentMethod || 'ç¾é‡‘'; // Backward compatibility
                const paymentBadgeClass = paymentMethod === 'åˆ·å¡' 
                    ? 'text-blue-600 bg-blue-50 border-blue-200' 
                    : 'text-green-600 bg-green-50 border-green-200';
                const paymentIcon = paymentMethod === 'åˆ·å¡' ? 'ğŸ’³' : 'ğŸ’µ';

                trackedHtml += `
                    <div class="expense-record-card bg-white rounded-lg p-3 flex items-center justify-between border-l-4 border-orange-600">
                        <div class="flex-grow min-w-0 pr-2">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-base font-semibold text-gray-900 truncate">${item.name}</span>
                                <button onclick="deleteExpense('${item.id}')" class="text-red-500 hover:text-red-700 text-sm font-medium ml-2 flex-shrink-0">
                                    åˆªé™¤
                                </button>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 mt-1">
                                <span class="px-2 py-0.5 rounded text-xs font-medium border ${categoryClass.replace('border-', 'text-').replace('bg-', 'bg-')} flex-shrink-0">${item.category}</span>
                                <span class="px-2 py-0.5 rounded text-xs font-medium border ${paymentBadgeClass} flex-shrink-0">${paymentIcon} ${paymentMethod}</span>
                                <span class="text-xs text-gray-400 flex-shrink-0">${item.date.substring(5)}</span>
                            </div>
                        </div>
                        <div class="flex-shrink-0 ml-4 text-right">
                            <div class="text-lg font-extrabold text-orange-600 whitespace-nowrap">
                                Â¥${item.amount.toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Total Tracked Summary (Removed emoji)
            trackedHtml = `
                <div class="total-summary-card bg-orange-600 text-white rounded-xl p-4 mb-4 shadow-xl">
                    <div class="text-sm font-semibold mb-1"> ${currentSelectedTraveler.replace(' (è² è²¬äºº)', '')} è®Šå‹•è¨˜å¸³ç¸½é¡ (è³¼ç‰©/é¤é£²ç­‰ - JPYÂ¥)</div>
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-bold">ç¸½è¨ˆ:</span>
                        <span class="text-2xl font-extrabold text-yellow-300">JPYÂ¥ ${totalTrackedExpense.toLocaleString()}</span>
                    </div>
                </div>
            ` + trackedHtml;
        }

        trackedDiv.innerHTML = trackedHtml;
    }

    /**
     * Renders the packing list for the currently selected traveler.
     */
    function renderPackingList(list) {
        const contentDiv = document.getElementById('packingListContent');
        if (!list || list.length === 0) {
            contentDiv.innerHTML = '<p class="text-center text-gray-500 py-10">æ¸…å–®ç‚ºç©ºã€‚è«‹æ‰‹å‹•æ–°å¢é …ç›®ã€‚</p>';
            return;
        }

        // Group by category for cleaner display
        const groupedList = list.reduce((acc, item, index) => {
            const category = item.category;
            if (!acc[category]) acc[category] = [];
            acc[category].push({ ...item, index }); 
            return acc;
        }, {});

        let html = '';
        for (const [categoryKey, items] of Object.entries(groupedList)) {
            const categoryTitle = packingCategoryMap[categoryKey] || categoryKey;
            const titleColor = packingCategoryColor[categoryKey] || 'text-gray-700';

            html += `
                <div class="space-y-3 mb-6">
                    <h2 class="text-xl font-bold ${titleColor} border-b-2 border-cyan-200 pb-1 mb-3">
                        ${categoryTitle}
                    </h2>
            `;

            items.forEach(item => {
                const isPacked = item.packed;
                // Custom styles defined at the top
                const buttonClass = isPacked ? 'packed-btn' : 'unpack-btn';
                const buttonText = isPacked ? 'å·²æ‰“åŒ… âœ“' : 'æœªæ‰“åŒ…';
                const cardBg = isPacked ? 'bg-teal-100' : 'bg-white';
                const descriptionClass = item.description.includes('å¿…é ˆ') ? 'text-red-600 font-bold' : 'text-gray-500';

                html += `
                    <div class="list-item-card ${cardBg} rounded-lg p-4 flex items-center justify-between" data-index="${item.index}">
                        <div>
                            <div class="text-base font-semibold text-gray-900 leading-snug">
                                ${item.name}
                            </div>
                            ${item.description ? `<div class="text-sm ${descriptionClass} mt-1">${item.description}</div>` : ''}
                            <div class="space-x-2 mt-1">
                                <span class="luggage-tag ${item.luggage.includes('éš¨èº«') ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-700'} font-medium">${item.luggage}</span>
                            </div>
                        </div>
                        <button onclick="togglePacked(${item.index})" class="px-4 py-2 rounded-full text-sm font-bold transition duration-150 ${buttonClass}">
                            ${buttonText}
                        </button>
                    </div>
                `;
            });
            html += `</div>`;
        }
        contentDiv.innerHTML = html;
    }


    // --- Initialization ---
    
    /**
     * Attempts a sign-in function with exponential backoff for transient errors.
     * @param {Function} signInFunction - The function to execute (e.g., signInWithCustomToken or signInAnonymously).
     * @param {number} [maxRetries=5] - Maximum number of retries.
     */
    async function attemptSignIn(signInFunction, maxRetries = 5) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                // The sign-in function
                const userCredential = await signInFunction();
                console.log(`Sign-in successful on attempt ${i + 1}`);
                return userCredential;
            } catch (error) {
                // Only retry on specific network/transient errors
                if (error.code === 'auth/network-request-failed' && i < maxRetries - 1) {
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    console.warn(`Sign-in failed with network error. Retrying in ${delay / 1000}s... (Attempt ${i + 1}/${maxRetries})`);
                    document.getElementById('loadingIndicator').textContent = `é€£ç·šéŒ¯èª¤ï¼Œæ­£åœ¨é‡è©¦ (${i + 1}/${maxRetries})...`;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                    // Re-throw other errors or the last attempt's error
                    throw error;
                }
            }
        }
    }


    /**
     * Initializes Firebase and sets up authentication.
     */
    async function initFirebase() {
        if (!firebaseConfig) {
            console.error("Firebase config is missing.");
            document.getElementById('loadingIndicator').textContent = 'éŒ¯èª¤ï¼šFirebase è¨­å®šéºå¤±ã€‚';
            return;
        }
        
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Authentication Process (now uses retry logic)
        try {
            if (initialAuthToken) {
                console.log("Attempting sign-in with custom token...");
                await attemptSignIn(() => signInWithCustomToken(auth, initialAuthToken));
            } else {
                console.log("Attempting anonymous sign-in...");
                await attemptSignIn(() => signInAnonymously(auth));
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Authentication successful. User ID:", userId);
                    setupRealtimeListener();
                } else {
                    console.log("User is signed out or auth is still processing.");
                }
            });

        } catch (error) {
            console.error("Firebase Auth Error:", error);
            // Display a persistent error message if all retries fail
            document.getElementById('loadingIndicator').textContent = `é€£ç·šéŒ¯èª¤ï¼šèªè­‰å¤±æ•—ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ (${error.message})`;
        }
    }

    /**
     * Sets up the real-time listener for the itinerary document.
     */
    function setupRealtimeListener() {
        if (!isAuthReady || !db) return;

        const docRef = getItineraryDocRef();

        // 1. Check if the document exists (getDoc) and create if not
        getDoc(docRef).then(docSnap => {
            if (!docSnap.exists() || !docSnap.data().fixed_items) { // Check for new fixed_items structure
                console.log("Itinerary document not found or structure outdated, creating initial data...");
                // Use the new initial data structure
                return setDoc(docRef, initialItineraryData);
            }
        }).then(() => {
            // 2. Set up the real-time listener (onSnapshot)
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentItineraryData = data; // Store the latest data

                    console.log("Received Real-time Data Update:", data);
                    
                    // Render all sections
                    renderItineraryDetails(data.itinerary_details || [], data.flights);
                    renderMapLocations(data.map_locations);
                    
                    // NEW: Render the user selector and content based on current active tab
                    renderUserSelector();
                    
                    if (currentActiveTab === 'budget') {
                         renderBudget(data.fixed_items || [], data.expense_tracker[currentSelectedTraveler] || []);
                    } else if (currentActiveTab === 'packing') {
                         const activeTravelerList = data.packing_lists[currentSelectedTraveler] || data.packing_lists[TRAVELER_NAMES[0]] || [];
                         renderPackingList(activeTravelerList);
                    }

                } else {
                    console.log("Itinerary document not found for listener.");
                }
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                document.getElementById('loadingIndicator').textContent = 'è³‡æ–™åŒæ­¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚';
            });
        }).catch(error => {
            console.error("Initial Firestore setup error:", error);
            document.getElementById('loadingIndicator').textContent = 'ç„¡æ³•å»ºç«‹å…±äº«è³‡æ–™ã€‚';
        });
    }

    // Start the application
    initFirebase();
    // Default to the itinerary view now that it's fully populated
    showTab('itinerary'); 
</script>

</body>
</html>
