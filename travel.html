<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šäººå”ä½œæ—…éŠæ¸…å–® - é›²ç«¯åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a clean, mobile-first design */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F8FF; /* Light blue-white for a subtle ocean/sand feel */
        }
        .tab-active {
            border-bottom: 4px solid #06B6D4; /* Cyan 600 border for active tab (Okinawa Ocean) */
            color: #1F2937; /* Dark text */
            font-weight: 600;
        }
        .list-item-card {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s;
        }
        
        /* Interactive buttons */
        .packed-btn { background-color: #059669; color: white; box-shadow: 0 2px 4px rgba(5, 150, 105, 0.4); } /* Emerald 600 for Packed */
        .unpack-btn { background-color: #FBBF24; color: #78350F; box-shadow: 0 2px 4px rgba(251, 191, 36, 0.4); } /* Yellow for Unpacked/Warning */
        .luggage-tag { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 9999px; }

        /* Budget Styles */
        .fixed-budget-card { border-left: 5px solid #0E7490; } /* Deep Cyan 700 - Fixed Costs NT$ */
        .expense-record-card { border-left: 3px solid #F97316; } /* Orange 600 for expense - Variable Costs JPYÂ¥ */
        .total-summary-card { background-color: #0891B2; } /* Cyan 700 - Stronger Blue */

        /* Itinerary Flight Card */
        .flight-card {
            background-color: #ECFEFF; /* Cyan 50 - Very Light Blue */
            border: 1px solid #67E8F9; /* Cyan 300 */
        }
        
        /* User Selector */
        #user-selector-container {
            border-bottom: 1px solid #E5E7EB;
        }
        .user-tag {
            cursor: pointer;
            transition: all 0.2s;
        }
        .user-tag-active {
            background-color: #06B6D4; /* Cyan 600 */
            color: white;
            box-shadow: 0 2px 4px rgba(6, 182, 212, 0.4);
        }
        
        /* Tab Icons Style */
        .tab-icon {
            width: 1.75rem;
            height: 1.75rem;
        }
    </style>
</head>
<body class="min-h-screen">

<div class="max-w-md mx-auto bg-white min-h-screen">
    
    <!-- Loading/Status Indicator -->
    <div id="loadingIndicator" class="p-4 text-center bg-yellow-100 text-yellow-800 font-semibold">
        è¼‰å…¥ä¸­... æ­£åœ¨å»ºç«‹é€£ç·š...
    </div>

    <!-- User Selector for Packing List and Budget -->
    <div id="user-selector-container" class="p-3 bg-white hidden">
        <p class="text-sm font-semibold text-gray-600 mb-2">æ—…ä¼´æ¸…å–®/è¨˜å¸³ç°¿ (é»æ“Šåˆ‡æ›è¦–è§’):</p>
        <div id="userSelector" class="flex space-x-2 overflow-x-auto pb-2">
            <!-- User tags will be inserted here -->
        </div>
    </div>


    <!-- Header/Tab Navigation with Icons Only -->
    <div class="flex justify-around border-b border-gray-200 p-3 bg-white">
        <!-- Itinerary Tab -->
        <div id="tabItinerary" class="text-center p-2 cursor-pointer tab-active flex flex-col items-center justify-center w-1/4" onclick="showTab('itinerary')">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/>
            </svg>
        </div>
        <!-- Map Tab -->
        <div id="tabMap" class="text-center p-2 text-gray-500 hover:text-gray-700 cursor-pointer flex flex-col items-center justify-center w-1/4" onclick="showTab('map')">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/>
            </svg>
        </div>
        <!-- Budget Tab -->
        <div id="tabBudget" class="text-center p-2 text-gray-500 hover:text-gray-700 cursor-pointer flex flex-col items-center justify-center w-1/4" onclick="showTab('budget')">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="20" height="16" x="2" y="4" rx="2" ry="2"/>
                <path d="M22 7.5H4"/>
                <path d="M12 11h.01"/>
                <path d="M17 11h.01"/>
            </svg>
        </div>
        <!-- Packing Tab -->
        <div id="tabPacking" class="text-center p-2 text-gray-500 hover:text-gray-700 cursor-pointer flex flex-col items-center justify-center w-1/4" onclick="showTab('packing')">
            <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="20" height="14" x="2" y="7" rx="2"/><path d="M14 2h-4a2 2 0 0 0-2 2v3h8V4a2 2 0 0 0-2-2Z"/>
            </svg>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="p-4">

        <!-- Tab 1: è¡Œç¨‹ç´°ç¯€ -->
        <div id="itineraryDetailView" class="space-y-6">
            <div id="itineraryDetailContent">
                <p class="text-center text-gray-500 py-10">æ­£åœ¨åŒæ­¥è¡Œç¨‹è³‡æ–™...</p>
            </div>
        </div>

        <!-- Tab 2: åœ°åœ–å°èˆª -->
        <div id="mapView" class="space-y-6 hidden">
            <p class="text-sm text-gray-600 mb-4 bg-cyan-50 p-3 rounded-lg border-l-4 border-cyan-400">
                é»æ“Šåœ°é»æ—çš„ã€Œå°èˆªã€æŒ‰éˆ•ï¼Œå³å¯åœ¨æ–°è¦–çª—ä¸­é–‹å•Ÿ Google åœ°åœ–ã€‚
            </p>
            <div id="mapContent">
                <p class="text-center text-gray-500 py-10">æ­£åœ¨æ•´ç†åœ°é»è³‡è¨Š...</p>
            </div>
        </div>
        
        <!-- Tab 3: èŠ±è²»é ç®— -->
        <div id="budgetView" class="space-y-6 hidden">
            <p id="budgetTravelerMessage" class="text-sm font-semibold mb-4 bg-purple-100 p-3 rounded-lg border-l-4 border-purple-400 text-purple-800">
                æ‚¨æ­£åœ¨æª¢è¦–çš„æ˜¯ **å€‹äºº** å›ºå®šè²»ç”¨èˆ‡è®Šå‹•è¨˜å¸³ã€‚
            </p>

            <div id="fixedExpensesSummary"></div>

            <div class="bg-white rounded-lg p-4 shadow-lg border border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">æ–°å¢å€‹äººèŠ±è²»</h3>
                <form id="expenseForm" onsubmit="addExpense(event)">
                    <div class="mb-3">
                        <label for="expenseDescription" class="block text-sm font-medium text-gray-700">é …ç›®æè¿°</label>
                        <input type="text" id="expenseDescription" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-cyan-600 focus:border-cyan-600">
                    </div>
                    <div class="flex space-x-3 mb-3">
                        <div class="flex-1">
                            <label for="expenseAmount" class="block text-sm font-medium text-gray-700">é‡‘é¡ (JPYÂ¥)</label>
                            <input type="number" id="expenseAmount" required min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-cyan-600 focus:border-cyan-600">
                        </div>
                        <div class="flex-1">
                            <label for="expenseCategory" class="block text-sm font-medium text-gray-700">é¡åˆ¥</label>
                            <select id="expenseCategory" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border bg-white focus:ring-cyan-600 focus:border-cyan-600">
                                <option value="é¤é£²èˆ‡é›¶é£Ÿ">é¤é£²èˆ‡é›¶é£Ÿ</option>
                                <option value="è³¼ç‰©èˆ‡ç´€å¿µå“">è³¼ç‰©èˆ‡ç´€å¿µå“</option>
                                <option value="äº¤é€šèˆ‡æ²¹è²»">äº¤é€šèˆ‡æ²¹è²»</option>
                                <option value="æ™¯é»èˆ‡å¨›æ¨‚ (è‡¨è³¼)">æ™¯é»èˆ‡å¨›æ¨‚</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä»˜æ¬¾æ–¹å¼</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="paymentMethod" value="ç¾é‡‘" checked class="form-radio text-cyan-600 focus:ring-cyan-600 h-4 w-4">
                                <span class="ml-2 text-gray-700">ğŸ’µ ç¾é‡‘</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="paymentMethod" value="åˆ·å¡" class="form-radio text-cyan-600 focus:ring-cyan-600 h-4 w-4">
                                <span class="ml-2 text-gray-700">ğŸ’³ åˆ·å¡</span>
                            </label>
                        </div>
                    </div>

                    <button type="submit" id="addExpenseBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                        æ–°å¢è¨˜å¸³ (åŒæ­¥å„²å­˜)
                    </button>
                </form>
            </div>
            
            <div id="trackedExpensesList"></div>
        </div>

        <!-- Tab 4: è¡Œææ¸…å–® -->
        <div id="packingListView" class="space-y-6 hidden">
            <p id="packingListUserMessage" class="text-sm font-semibold mb-4 bg-yellow-100 p-3 rounded-lg border-l-4 border-yellow-400 text-yellow-800">
                æ‚¨æ­£åœ¨æª¢è¦–çš„æ˜¯**å€‹äºº**æ‰“åŒ…æ¸…å–®ã€‚
            </p>
            <div id="packingListContent">
                <p class="text-center text-gray-500 py-10">æ­£åœ¨åŒæ­¥æ¸…å–®è³‡æ–™...</p>
            </div>
        </div>

    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global Variables and Firebase Setup ---
    setLogLevel('Debug');
    
    // --- ä½¿ç”¨è€…è‡ªè¨‚ Firebase è¨­å®š (å·²æ›´æ–°æ‚¨çš„é‡‘é‘°) ---
    const firebaseConfig = {
      apiKey: "AIzaSyC2m7MgOBv3kTzsgjXwmvKIF7HTwfBHXVQ",
      authDomain: "travel-c7e0e.firebaseapp.com",
      projectId: "travel-c7e0e",
      storageBucket: "travel-c7e0e.firebasestorage.app",
      messagingSenderId: "846502519898",
      appId: "1:846502519898:web:efa2cc0fb1be631375a463",
      measurementId: "G-KQZBN42L32"
    };

    // ä½¿ç”¨æ‚¨çš„å°ˆæ¡ˆ ID ä½œç‚º App IDï¼Œç¢ºä¿è³‡æ–™ç¨ç«‹
    const appId = 'travel-c7e0e-trip'; 

    // è¨­å®šç‚º null (ä½¿ç”¨åŒ¿åç™»å…¥)
    const initialAuthToken = null;

    let app;
    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;
    
    // Use a fixed public ID for this shared itinerary across all users.
    const SHARED_ITINERARY_ID = 'collaborative-trip-v4'; 
    
    // Traveler names
    const TRAVELER_NAMES = ['æŸè¨€ä½©çŠ (è² è²¬äºº)', 'çˆ¸çˆ¸åª½åª½', 'æŸå»·å¹¼å¨œ'];
    let currentSelectedTraveler = TRAVELER_NAMES[0]; 
    
    let currentItineraryData = null; 
    let currentActiveTab = 'itinerary'; 

    // Firestore Path
    const getItineraryDocRef = () => {
        if (!db) return null;
        // ä½¿ç”¨æ‚¨å°ˆæ¡ˆä¸‹çš„ artifacts é›†åˆ
        const path = `/artifacts/${appId}/public/data/itineraries/${SHARED_ITINERARY_ID}`;
        return doc(db, path);
    };

    // --- Data Definitions (Static defaults for initialization) ---
    const map_locations_data = [
        { name: "é£¯åº—å…¥ä½åœ°é»", location: "2-chÅme-1-15 Kumoji ä¹…èŒ‚åœ°ç¬¬ä¸€ãƒ“ãƒ« ï¼“éš", type: "ä½å®¿", day: 1, description: "åœ‹éš›é€šå‘¨é‚Šï¼Œäº¤é€šä¾¿åˆ©ã€‚" },
        { name: "ORIXç§Ÿè»Š (ç¾æ „æ©‹ç«™å‰å–è»Š)", location: "https://maps.app.goo.gl/J88aLvqwCAerdvFY6", type: "äº¤é€š", day: 2, description: "ORIX ç¾æ „æ©‹ç«™å‰å¤–èªæ«ƒæª¯å–è»Šã€‚" },
        { name: "ç¬¬ä¸€ç‰§å¿—å…¬è¨­å¸‚å ´", location: "ç¬¬ä¸€ç‰§å¿—å…¬è¨­å¸‚å ´", type: "æ™¯é»", day: 2, description: "æ²–ç¹©å»šæˆ¿ï¼å¯é¸è³¼æ–°é®®æµ·ç”¢ã€‚" },
        { name: "è±¬è‚‰è›‹é£¯ç³° (æ—©é¤)", location: "Pork Tamago Onigiri Makishi Market", type: "é¤é£²", day: 2, description: "å¿…åƒæ²–ç¹©ç¶“å…¸æ—©é¤ã€‚" },
        { name: "ç€¨é•·å³¶", location: "ç€¨é•·å³¶", type: "æ™¯é»", day: 2, description: "ç™½è‰²å¸Œè‡˜é¢¨æ ¼èšè½ï¼Œç„¡æ•µæµ·æ™¯ã€‚" },
        { name: "å¹¸ç¦é¬†é¤…", location: "å¹¸ç¦é¬†é¤… ç€¨é•·å³¶", type: "é¤é£²", day: 2, description: "è¶…äººæ°£æ’éšŠèˆ’èŠ™è•¾é¬†é¤…ã€‚" },
        { name: "æ°¾æ¿«æ¼¢å ¡", location: "æ°¾æ¿«æ¼¢å ¡ ç€¨é•·å³¶", type: "é¤é£²", day: 2, description: "ä»½é‡åè¶³ç¾å¼æ¼¢å ¡ã€‚" },
        { name: "ç‚­ç«ç„¼è‚‰ã¶ã¡ä¹…èŒ‚åœ°åº— (æ™šé¤)", location: "ç‚­ç«ç„¼è‚‰ã¶ã¡ä¹…èŒ‚åœ°åº—", type: "é¤é£²", day: 2, description: "å·²é è¨‚æ™šé¤ç‡’è‚‰ã€‚" },
        { name: "å¡”å¯é£¯å’–å•¡", location: "https://maps.app.goo.gl/mKrYw7Z21zY1VxCM7", type: "é¤é£²", day: 2, description: "ç‰¹è‰²æ²–ç¹©å¡”å¯é£¯ã€‚" },
        { name: "Lawson æ™‚ä»£å¤§å»ˆåº—", location: "Lawson æ™‚ä»£å¤§å»ˆåº—", type: "è³¼ç‰©", day: 3, description: "ä¾¿åˆ©å•†åº—æ¡è²·æ—©é¤é£²æ–™ã€‚" },
        { name: "å¤å®‡åˆ©å³¶", location: "å¤å®‡åˆ©å³¶", type: "æ™¯é»", day: 3, description: "å¤å®‡åˆ©å¤§æ©‹èˆ‡ç¾éº—æµ·ç˜ã€‚" },
        { name: "è¦è¦é£¯ (åˆé¤)", location: "è¦è¦é£¯ å¤å®‡åˆ©å³¶", type: "é¤é£²", day: 3, description: "äººæ°£é¤è»Šç¾é£Ÿã€‚" },
        { name: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨", location: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨", type: "æ™¯é»", day: 3, description: "å¿…è¨ªé»‘æ½®ä¹‹æµ·ã€‚" },
        { name: "MaxValu ç‰§å¿—åº— (è¶…å¸‚)", location: "MaxValu ç‰§å¿—åº—", type: "è³¼ç‰©", day: 3, description: "å¤§å‹è¶…å¸‚ï¼Œé©åˆè²·é›¶é£Ÿã€‚" },
        { name: "åœ‹éš›é€š (æ¡è³¼)", location: "åœ‹éš›é€š æ²–ç¹©", type: "è³¼ç‰©", day: 4, description: "é‚£éœ¸æœ€ç†±é¬§å•†åº—è¡—ã€‚" },
        { name: "æ²–ç¸„ãã°ã‚¿ã‚¤ãƒ©è£½éººæ‰€ (åˆé¤)", location: "æ²–ç¸„ãã°ã‚¿ã‚¤ãƒ©è£½éººæ‰€ å›½éš›é€šã‚Šåº—", type: "é¤é£²", day: 4, description: "æ­£å®—æ²–ç¹©éºµã€‚" },
        { name: "SAN-Aæµ¦æ·»è¥¿æµ·å²¸ PARCO CITY", location: "https://maps.app.goo.gl/3TaAuTahx5D9uFKu6", type: "è³¼ç‰©", day: 4, description: "æ²–ç¹©æœ€å¤§æµ·æ™¯è³¼ç‰©ä¸­å¿ƒã€‚" },
        { name: "ORIXç§Ÿè»Š (é‚„è»Š)", location: "https://maps.app.goo.gl/J88aLvqwCAerdvFY6", type: "äº¤é€š", day: 4, description: "ç¾æ „æ©‹ç«™å‰å¤–èªæ«ƒæª¯é‚„è»Šã€‚" },
        { name: "å¤§åœ‹è—¥å¦ (åœ‹éš›é€š)", location: "https://maps.app.goo.gl/yhQFhZm11fcjGumh9", type: "è³¼ç‰©", day: 4, description: "æ¡è³¼è—¥å¦å¥½å»è™•ã€‚" },
        { name: "å”å‰è¨¶å¾· (åœ‹éš›é€š)", location: "https://maps.app.goo.gl/8e5dtA7rYmAvkCyq9", type: "è³¼ç‰©", day: 4, description: "24å°æ™‚ç‡Ÿæ¥­ç¶œåˆæŠ˜æ‰£åº—ã€‚" },
    ];

    const FIXED_BUDGET_ITEMS = [
        { name: "è™èˆªä¾†å›æ©Ÿç¥¨", category: "äº¤é€šèˆ‡ä½å®¿", amount: 7500, description: "å–®äººä¾†å›æ©Ÿç¥¨ NT$7,500", appliesTo: ['all'] },
        { name: "äº”å¤©å››å¤œä½å®¿", category: "äº¤é€šèˆ‡ä½å®¿", amount: 3608, description: "å–®äººä»½ä½å®¿åˆ†æ”¤è²»ç”¨ç¸½é¡", appliesTo: ['all'] }, 
        { name: "è‡ªé§•ç§Ÿè»Š", category: "äº¤é€šèˆ‡ä½å®¿", amount: 1285, description: "ç§Ÿè»Šè²»ç”¨ï¼ˆé ä¼°é‡‘é¡ï¼Œä»¥ç•¶æ—¥åŒ¯ç‡è¨ˆç®—ï¼‰", appliesTo: ['all'] },
        { name: "ç¶²å¡è²»ç”¨", category: "æ¡è³¼èˆ‡é›œé …", amount: 343, description: "æ²–ç¹©äº”æ—¥ç¶²è·¯è²»ç”¨", appliesTo: ['all'] },
        { name: "æ—…éŠå¹³å®‰éšª (æˆäºº)", category: "æ¡è³¼èˆ‡é›œé …", amount: 507, description: "å–®äººä»½æ—…è¡Œå¹³å®‰éšªè²»ç”¨ (æˆäºº NT$507/äºº)", appliesTo: ['æŸè¨€ä½©çŠ (è² è²¬äºº)', 'çˆ¸çˆ¸åª½åª½', 'æŸå»·å¹¼å¨œ'] },
        { name: "æ—…éŠå¹³å®‰éšª (å­©ç«¥)", category: "æ¡è³¼èˆ‡é›œé …", amount: 313, description: "å–®äººä»½æ—…è¡Œå¹³å®‰éšªè²»ç”¨ (å­©ç«¥ NT$313/äºº)", appliesTo: ['æŸå»·å¹¼å¨œ'] },
        { name: "æ°´æ—é¤¨é–€ç¥¨ (æˆäºº)", category: "æ™¯é»èˆ‡å¨›æ¨‚", amount: 370, description: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨å–®äººæˆäººç¥¨", appliesTo: ['all'] }, 
        { name: "æ°´æ—é¤¨é–€ç¥¨ (å…’ç«¥)", category: "æ™¯é»èˆ‡å¨›æ¨‚", amount: 144, description: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨å–®äººå…’ç«¥ç¥¨", appliesTo: ['æŸå»·å¹¼å¨œ'] },
        { name: "é«˜éµç¥¨ (å°å—â†’æ¡ƒåœ’)", category: "äº¤é€šèˆ‡ä½å®¿", amount: 1190, description: "å°å—åˆ°æ¡ƒåœ’å–®ç¨‹é«˜éµç¥¨ (æˆäººåƒ¹)", appliesTo: ['æŸè¨€ä½©çŠ (è² è²¬äºº)'] },
        { name: "é«˜éµç¥¨ (å˜‰ç¾©â†’æ¡ƒåœ’) - æˆäºº", category: "äº¤é€šèˆ‡ä½å®¿", amount: 920, description: "å˜‰ç¾©åˆ°æ¡ƒåœ’å–®ç¨‹é«˜éµç¥¨ (æˆäººåƒ¹)", appliesTo: ['çˆ¸çˆ¸åª½åª½', 'æŸå»·å¹¼å¨œ'] },
        { name: "é«˜éµç¥¨ (å˜‰ç¾©â†’æ¡ƒåœ’) - å­©ç«¥", category: "äº¤é€šèˆ‡ä½å®¿", amount: 460, description: "å˜‰ç¾©åˆ°æ¡ƒåœ’å–®ç¨‹é«˜éµç¥¨ (å­©ç«¥åƒ¹)", appliesTo: ['æŸå»·å¹¼å¨œ'] },
    ];
    
    const initialCommonPackingList = [
        { name: "è­·ç…§ã€å…¥å¢ƒè¡¨", category: "document", luggage: "éš¨èº«è¡Œæ", packed: false, description: "æ—…è¡Œå¿…å‚™ï¼" },
        { name: "æ©Ÿç¥¨ã€å°ç£é§•ç…§ã€åœ‹éš›é§•ç…§", category: "document", luggage: "éš¨èº«è¡Œæ", packed: false, description: "é›»å­æˆ–ç´™æœ¬å‚™ä»½" },
        { name: "å¤–å¹£ / ä¿¡ç”¨å¡", category: "document", luggage: "éš¨èº«è¡Œæ", packed: false, description: "" },
        { name: "å¤–å¥— / ä¿æš–è¡£ç‰©", category: "clothing", luggage: "éš¨èº«è¡Œæ / æ‰˜é‹", packed: false, description: "æ‡‰å°æ—©æ™šæº«å·®" },
        { name: "æ›æ´—è¡£ç‰©/è²¼èº«è¡£ç‰© ", category: "clothing", luggage: "æ‰˜é‹", packed: false, description: "" },
        { name: "ç›¥æ´—ç”¨å“ (100mlä»¥ä¸Š)", category: "hygiene", luggage: "æ‰˜é‹", packed: false, description: "æ³¨æ„ï¼šæ¶²é«”å®¹é‡é™åˆ¶" },
        { name: "å¸¸å‚™è—¥å“ (æ„Ÿå†’è—¥/èƒƒè—¥)", category: "hygiene", luggage: "éš¨èº«è¡Œæ", packed: false, description: "å»ºè­°ä¿ç•™åŸåŒ…è£" },
        { name: "è¡Œå‹•é›»æº (å¿…éš¨èº«)", category: "electronics", luggage: "éš¨èº«è¡Œæ", packed: false, description: "**å¿…é ˆ**éš¨èº«æ”œå¸¶ï¼Œä¸å¯æ‰˜é‹ï¼" },
    ];
    
    const initialItineraryData = {
        itinerary_title: "æ²–ç¹©äº”å¤©å››å¤œæ—…éŠè¡Œç¨‹è¡¨",
        flights: {
            outbound: { airline: "tigersmart", flight_number: "IT232", departure: "TPE æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ ", departure_time: "2025-12-21 18:20 PM", arrival: "OKA æ²–ç¹©é‚£éœ¸æ©Ÿå ´", arrival_time: "2025-12-21 20:40 PM" },
            return: { airline: "tigersmart", flight_number: "IT797", departure: "OKA æ²–ç¹©é‚£éœ¸æ©Ÿå ´", departure_time: "2025-12-25 13:30 PM", arrival: "TNN å°å—æ©Ÿå ´", arrival_time: "2025-12-25 14:20 PM" }
        },
        itinerary_details: [
            { day: 1, date: "12/21 (æ—¥)", time_range: "18:20 PM - æ™šé–“", title: "æ™šç­æ©ŸæŠµé” / é£¯åº—ä¼‘æ¯", description_items: ["èˆªç­ IT232 (18:20 PM) æŠµé” OKAã€‚", "å‰å¾€å…¥ä½é£¯åº—ï¼šä¹…èŒ‚åœ°ç¬¬ä¸€ãƒ“ãƒ«ã€‚"], notes_items: ["æ™šé¤è‡ªç†"] },
            { day: 2, date: "12/22 (ä¸€)", time_range: "08:30 - 20:00", title: "æµ·é®®å¸‚å ´èˆ‡ç¾åœ‹æ‘", description_items: ["08:00 ORIXå–è»Š", "08:30 ç‰§å¿—å…¬è¨­å¸‚å ´", "11:40 ç€¨é•·å³¶", "13:40 ç¾åœ‹æ‘", "18:30 æ™šé¤ï¼šç‚­ç«ç„¼è‚‰ã¶ã¡"], notes_items: ["æ—©é¤ï¼šè±¬è‚‰è›‹é£¯ç³°", "è»Šç¨‹ç´„35åˆ†é˜"] },
            { day: 3, date: "12/23 (äºŒ)", time_range: "08:00 - 18:00", title: "å¤å®‡åˆ©å³¶èˆ‡ç¾éº—æµ·æ°´æ—é¤¨", description_items: ["08:00 Lawsonæ¡è³¼", "09:30 å¤å®‡åˆ©å³¶", "11:30 æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨", "17:00 è¶…å¸‚æ¡è³¼", "18:00 è¿”å›é£¯åº—"], notes_items: ["è»Šç¨‹ç´„1.5å°æ™‚", "æ¨è–¦åˆé¤ï¼šè¦è¦é£¯"] },
            { day: 4, date: "12/24 (ä¸‰)", time_range: "09:30 - 17:30", title: "ä¼´æ‰‹ç¦®è¡€æ‹¼ & PARCO CITY", description_items: ["09:30 åœ‹éš›é€šä¼´æ‰‹ç¦®", "11:30 åœ‹éš›é€šåˆé¤", "13:30 PARCO CITY", "17:30 ORIXé‚„è»Š"], notes_items: ["åˆé¤ï¼šæ²–ç¹©éºµ", "é‚„è»Šå¾Œæ™šé¤è‡ªç†"] },
            { day: 5, date: "12/25 (å››)", time_range: "æ—©ä¸Š", title: "æ­æ©Ÿå›ç¨‹", description_items: ["å›ç¨‹èˆªç­ IT797 (13:30 PM èµ·é£›)", "æŠµé” TNN å°å—æ©Ÿå ´ (14:20 PM)"], notes_items: ["éœ€11:00æŠµé”æ©Ÿå ´"] },
        ],
        packing_lists: {
            'æŸè¨€ä½©çŠ (è² è²¬äºº)': [...initialCommonPackingList, { name: "DJI ç›¸æ©Ÿ ", category: "electronics", luggage: "éš¨èº«è¡Œæ", packed: false, description: "ç¢ºèªé›»æ± å……é£½ã€‚" }],
            'çˆ¸çˆ¸åª½åª½': [...initialCommonPackingList, { name: "é ¸æ• / çœ¼ç½©", category: "hygiene", luggage: "éš¨èº«è¡Œæ", packed: false, description: "æ©Ÿä¸ŠåŠè»Šä¸Šä¼‘æ¯ç”¨" }],
            'æŸå»·å¹¼å¨œ': [...initialCommonPackingList, { name: "å…’ç«¥é†«è—¥åŒ…", category: "hygiene", luggage: "éš¨èº«è¡Œæ", packed: false, description: "å…’ç«¥å°ˆç”¨è—¥å“" }]
        },
        fixed_items: FIXED_BUDGET_ITEMS, 
        expense_tracker: { 'æŸè¨€ä½©çŠ (è² è²¬äºº)': [], 'çˆ¸çˆ¸åª½åª½': [], 'æŸå»·å¹¼å¨œ': [] },
        map_locations: map_locations_data, 
        lastUpdated: new Date().toISOString()
    };

    // --- Utility & Handlers ---

    const packingCategoryMap = { 'document': 'æ–‡ä»¶èˆ‡é‡‘è', 'clothing': 'è¡£ç‰©èˆ‡é…ä»¶', 'hygiene': 'ç›¥æ´—èˆ‡è—¥å“', 'electronics': 'é›»å­èˆ‡é›œé …' };
    const packingCategoryColor = { 'document': 'text-cyan-700', 'clothing': 'text-purple-700', 'hygiene': 'text-teal-700', 'electronics': 'text-orange-700' };
    const budgetCategoryColor = { 
        'äº¤é€šèˆ‡ä½å®¿': 'border-cyan-400 bg-cyan-50', 'æ™¯é»èˆ‡å¨›æ¨‚': 'border-teal-400 bg-teal-50', 
        'é¤é£²èˆ‡é›¶é£Ÿ': 'border-red-400 bg-red-50', 'è³¼ç‰©èˆ‡ç´€å¿µå“': 'border-pink-400 bg-pink-50',
        'äº¤é€šèˆ‡æ²¹è²»': 'border-yellow-400 bg-yellow-50', 'æ™¯é»èˆ‡å¨›æ¨‚ (è‡¨è³¼)': 'border-green-400 bg-green-50',
        'æ¡è³¼èˆ‡é›œé …': 'border-pink-400 bg-pink-50', 'å…¶ä»–': 'border-gray-400 bg-gray-50'
    };
    const locationTypeColor = { 'ä½å®¿': 'bg-red-100 text-red-800', 'äº¤é€š': 'bg-cyan-100 text-cyan-800', 'æ™¯é»': 'bg-emerald-100 text-emerald-800', 'é¤é£²': 'bg-yellow-100 text-yellow-800', 'è³¼ç‰©': 'bg-blue-100 text-blue-800' };

    window.openMap = (query) => {
        if (query.startsWith('http')) window.open(query, '_blank');
        else window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query + " æ²–ç¹©")}`, '_blank');
    };
    
    window.selectTraveler = (travelerName) => {
        currentSelectedTraveler = travelerName;
        renderUserSelector(); 
        if (currentActiveTab === 'packing') renderPackingList(currentItineraryData.packing_lists[currentSelectedTraveler] || []);
        else if (currentActiveTab === 'budget') renderBudget(currentItineraryData.fixed_items, currentItineraryData.expense_tracker[currentSelectedTraveler] || []);
        else showTab('packing');
    }

    window.showTab = (tabName) => {
        currentActiveTab = tabName;
        const views = { itinerary: 'itineraryDetailView', map: 'mapView', packing: 'packingListView', budget: 'budgetView' };
        const tabs = { itinerary: 'tabItinerary', map: 'tabMap', packing: 'tabPacking', budget: 'tabBudget' };
        
        document.getElementById('user-selector-container').classList.toggle('hidden', !(tabName === 'packing' || tabName === 'budget'));
        if(tabName === 'packing' || tabName === 'budget') renderUserSelector();

        Object.keys(views).forEach(k => document.getElementById(views[k]).classList.add('hidden'));
        Object.keys(tabs).forEach(k => {
            const el = document.getElementById(tabs[k]);
            el.classList.remove('tab-active', 'text-gray-900');
            el.classList.add('text-gray-500');
        });

        document.getElementById(views[tabName]).classList.remove('hidden');
        document.getElementById(tabs[tabName]).classList.add('tab-active', 'text-gray-900');
        document.getElementById(tabs[tabName]).classList.remove('text-gray-500');
        
        if (currentItineraryData) {
            if (tabName === 'map') renderMapLocations(currentItineraryData.map_locations);
            else if (tabName === 'packing') renderPackingList(currentItineraryData.packing_lists[currentSelectedTraveler] || []);
            else if (tabName === 'budget') renderBudget(currentItineraryData.fixed_items, currentItineraryData.expense_tracker[currentSelectedTraveler] || []);
        }
    };

    // --- Firestore Updates ---

    window.togglePacked = async (index) => {
        if (!isAuthReady || !userId) return;
        const docRef = getItineraryDocRef();
        if (!docRef) return;
        try {
            const docSnapshot = await getDoc(docRef);
            if (!docSnapshot.exists()) return;
            const data = docSnapshot.data();
            const list = data.packing_lists[currentSelectedTraveler];
            list[index].packed = !list[index].packed;
            await updateDoc(docRef, { [`packing_lists.${currentSelectedTraveler}`]: list, lastUpdated: new Date().toISOString() });
        } catch (e) { console.error(e); }
    };
    
    window.addExpense = async (event) => {
        event.preventDefault();
        if (!isAuthReady || !userId) return;

        const desc = document.getElementById('expenseDescription').value.trim();
        const amt = parseInt(document.getElementById('expenseAmount').value, 10);
        const cat = document.getElementById('expenseCategory').value;
        const method = document.querySelector('input[name="paymentMethod"]:checked').value;
        const btn = document.getElementById('addExpenseBtn');
        
        btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­...';

        const docRef = getItineraryDocRef();
        try {
            const docSnapshot = await getDoc(docRef);
            if (!docSnapshot.exists()) return;
            const data = docSnapshot.data();
            const list = data.expense_tracker[currentSelectedTraveler] || [];
            
            list.push({ id: Date.now().toString(), name: desc, amount: amt, category: cat, paymentMethod: method, date: new Date().toISOString().substring(0, 10) });
            await updateDoc(docRef, { [`expense_tracker.${currentSelectedTraveler}`]: list, lastUpdated: new Date().toISOString() });
            
            document.getElementById('expenseForm').reset();
            document.querySelector('input[name="paymentMethod"][value="ç¾é‡‘"]').checked = true;
        } catch (e) { console.error(e); } 
        finally { btn.disabled = false; btn.textContent = 'æ–°å¢è¨˜å¸³ (åŒæ­¥å„²å­˜)'; }
    }
    
    window.deleteExpense = async (expenseId) => {
        if (!isAuthReady || !userId) return;
        const docRef = getItineraryDocRef();
        try {
            const docSnapshot = await getDoc(docRef);
            if (!docSnapshot.exists()) return;
            const data = docSnapshot.data();
            const list = data.expense_tracker[currentSelectedTraveler] || [];
            const updated = list.filter(item => item.id !== expenseId);
            await updateDoc(docRef, { [`expense_tracker.${currentSelectedTraveler}`]: updated, lastUpdated: new Date().toISOString() });
        } catch (e) { console.error(e); }
    }

    // --- Renderers ---
    
    function renderUserSelector() {
        document.getElementById('userSelector').innerHTML = TRAVELER_NAMES.map(name => {
            const active = name === currentSelectedTraveler ? 'user-tag-active' : 'bg-gray-200 text-gray-700';
            const icon = name.includes('è² è²¬äºº') ? 'ğŸ‘‘' : 'ğŸ‘¤';
            return `<span class="user-tag text-sm font-semibold py-2 px-4 rounded-full flex-shrink-0 ${active}" onclick="selectTraveler('${name.replace(/'/g, "\\'")}')">${icon} ${name.replace(' (è² è²¬äºº)', '')}</span>`;
        }).join('');
        
        const msgEl = currentActiveTab === 'packing' ? document.getElementById('packingListUserMessage') : document.getElementById('budgetTravelerMessage');
        const action = currentActiveTab === 'packing' ? 'æ‰“åŒ…æ¸…å–®' : 'è²»ç”¨è¨˜å¸³';
        if(msgEl) msgEl.innerHTML = `æ‚¨æ­£åœ¨æª¢è¦– **${currentSelectedTraveler.replace(' (è² è²¬äºº)', '')}** çš„${action}ã€‚`;
    }
    
    function renderItineraryDetails(details, flights) {
        let html = '';
        if (flights) {
            ['outbound', 'return'].forEach(type => {
                const f = flights[type];
                html += `<div class="flight-card rounded-lg p-3 mb-2 text-sm"><div class="flex justify-between font-bold text-gray-700 border-b border-dashed pb-1 mb-1"><span>${type==='outbound'?'å»ç¨‹':'å›ç¨‹'} ${f.airline}</span><span>${f.flight_number}</span></div><div class="flex justify-between"><span>${f.departure_time.split(' ')[1]} ${f.departure.slice(0,3)}</span><span>â†’</span><span>${f.arrival_time.split(' ')[1]} ${f.arrival.slice(0,3)}</span></div></div>`;
            });
        }
        html += details.map(d => `
            <div class="bg-cyan-50 rounded-xl p-4 mt-4 border border-cyan-200 flex items-start">
                <div class="mr-3 flex flex-col items-center w-12 flex-shrink-0"><div class="text-2xl font-bold text-cyan-600">D${d.day}</div><div class="text-[10px] text-gray-500">${d.date.split(' ')[0]}</div></div>
                <div>
                    <div class="font-bold text-gray-900 mb-1">${d.title}</div>
                    <ul class="list-disc pl-4 text-sm text-gray-700 mb-2">${d.description_items.map(i=>`<li>${i}</li>`).join('')}</ul>
                    ${d.notes_items && d.notes_items.length ? `<div class="text-xs text-amber-700 bg-amber-100 p-2 rounded"><b>å‚™è¨»:</b> ${d.notes_items.join('ã€')}</div>` : ''}
                </div>
            </div>
        `).join('');
        document.getElementById('itineraryDetailContent').innerHTML = html;
        document.getElementById('loadingIndicator').classList.add('hidden');
    }

    function renderMapLocations(locations) {
        if (!locations || !locations.length) return document.getElementById('mapContent').innerHTML = 'ç„¡è³‡æ–™';
        const groups = locations.reduce((acc, item) => { (acc[item.day] = acc[item.day] || []).push(item); return acc; }, {});
        let html = '';
        for (const [day, items] of Object.entries(groups)) {
            html += `<h2 class="text-xl font-bold text-cyan-600 border-b border-cyan-300 mt-6 mb-2">Day ${day}</h2>`;
            html += items.map(i => `
                <div class="bg-white rounded-lg p-3 mb-2 shadow-sm border-l-4 border-cyan-200 flex justify-between">
                    <div class="mr-2">
                        <div class="font-bold text-gray-800">${i.name} <span class="text-xs px-2 py-0.5 rounded-full ${locationTypeColor[i.type]}">${i.type}</span></div>
                        <div class="text-xs text-gray-500 mt-1">${i.description}</div>
                    </div>
                    <button onclick="openMap('${i.location.replace(/'/g, "\\'")}')" class="bg-emerald-500 text-white text-xs font-bold px-3 py-1 rounded-full self-start flex-shrink-0">å°èˆª</button>
                </div>
            `).join('');
        }
        document.getElementById('mapContent').innerHTML = html;
    }

    function renderBudget(fixed, tracked) {
        // Fixed
        let totalFixed = 0;
        const fixedHtml = fixed.filter(i => i.appliesTo.includes('all') || i.appliesTo.includes(currentSelectedTraveler)).map(item => {
            let mult = (currentSelectedTraveler.includes('è² è²¬äºº') || currentSelectedTraveler.includes('çˆ¸çˆ¸')) ? 2 : (currentSelectedTraveler.includes('å¹¼å¨œ') && item.name.includes('æ©Ÿç¥¨') ? 2 : 1);
            const amt = item.amount * mult;
            totalFixed += amt;
            return `<div class="fixed-budget-card bg-white p-3 rounded mb-2 shadow-sm flex justify-between"><div><div class="font-bold text-sm text-gray-800">${item.name}</div><div class="text-xs text-gray-500">${item.description} ${mult>1?`(x${mult})`:''}</div></div><div class="font-bold text-cyan-700">NT$ ${amt.toLocaleString()}</div></div>`;
        }).join('');
        document.getElementById('fixedExpensesSummary').innerHTML = `<div class="total-summary-card text-white p-3 rounded-lg mb-4 shadow flex justify-between"><span>å›ºå®šé ä»˜ç¸½é¡</span><span class="text-xl font-bold">NT$ ${totalFixed.toLocaleString()}</span></div>` + fixedHtml;

        // Tracked
        let totalTracked = 0;
        const trackedHtml = tracked.sort((a,b)=>b.id-a.id).map(item => {
            totalTracked += item.amount;
            const methodBadge = item.paymentMethod === 'åˆ·å¡' ? '<span class="text-blue-600 bg-blue-50 px-1 rounded border border-blue-200">ğŸ’³</span>' : '<span class="text-green-600 bg-green-50 px-1 rounded border border-green-200">ğŸ’µ</span>';
            return `<div class="expense-record-card bg-white p-3 rounded mb-2 shadow-sm flex justify-between items-center"><div><div class="font-bold text-gray-800">${item.name}</div><div class="text-xs text-gray-500 flex gap-1 mt-1"><span class="bg-gray-100 px-1 rounded">${item.category}</span> ${methodBadge} <span>${item.date.slice(5)}</span></div></div><div class="text-right"><div class="font-bold text-orange-600">Â¥${item.amount.toLocaleString()}</div><button onclick="deleteExpense('${item.id}')" class="text-xs text-red-400 underline">åˆªé™¤</button></div></div>`;
        }).join('');
        document.getElementById('trackedExpensesList').innerHTML = `<div class="bg-orange-600 text-white p-3 rounded-lg my-4 shadow flex justify-between"><span>è®Šå‹•è¨˜å¸³ç¸½é¡ (JPY)</span><span class="text-xl font-bold">Â¥ ${totalTracked.toLocaleString()}</span></div>` + (trackedHtml || '<div class="text-center text-gray-400 py-4">ç„¡è³‡æ–™</div>');
    }

    function renderPackingList(list) {
        if (!list || !list.length) return document.getElementById('packingListContent').innerHTML = '<div class="text-center py-10 text-gray-500">æ¸…å–®ç‚ºç©º</div>';
        const groups = list.reduce((acc, item, idx) => { (acc[item.category]=acc[item.category]||[]).push({...item, idx}); return acc; }, {});
        let html = '';
        for(const [cat, items] of Object.entries(groups)) {
            html += `<h3 class="font-bold text-gray-700 mt-4 mb-2 border-b border-gray-200">${packingCategoryMap[cat]||cat}</h3>`;
            html += items.map(i => `
                <div class="list-item-card ${i.packed?'bg-teal-50':'bg-white'} rounded-lg p-3 mb-2 flex justify-between items-center">
                    <div><div class="font-semibold ${i.packed?'text-teal-800 line-through':'text-gray-900'}">${i.name}</div><div class="text-xs text-gray-500">${i.description}</div></div>
                    <button onclick="togglePacked(${i.idx})" class="${i.packed?'packed-btn':'unpack-btn'} px-3 py-1 rounded-full text-xs font-bold shadow">${i.packed?'å·²æ‰“åŒ…':'æœªæ‰“åŒ…'}</button>
                </div>`).join('');
        }
        document.getElementById('packingListContent').innerHTML = html;
    }

    // --- Init ---
    async function initFirebase() {
        if (!firebaseConfig) return document.getElementById('loadingIndicator').textContent = 'éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¨­å®š';
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        try {
            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
            else await signInAnonymously(auth);
            
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    setupRealtimeListener();
                }
            });
        } catch (e) { document.getElementById('loadingIndicator').textContent = 'é€£ç·šå¤±æ•—'; console.error(e); }
    }

    function setupRealtimeListener() {
        const docRef = getItineraryDocRef();
        getDoc(docRef).then(snap => {
            if (!snap.exists()) return setDoc(docRef, initialItineraryData);
        }).then(() => {
            onSnapshot(docRef, snap => {
                if (!snap.exists()) return;
                currentItineraryData = snap.data();
                renderItineraryDetails(currentItineraryData.itinerary_details, currentItineraryData.flights);
                renderMapLocations(currentItineraryData.map_locations);
                if(currentActiveTab==='budget') renderBudget(currentItineraryData.fixed_items, currentItineraryData.expense_tracker[currentSelectedTraveler]||[]);
                if(currentActiveTab==='packing') renderPackingList(currentItineraryData.packing_lists[currentSelectedTraveler]||[]);
            });
        });
    }

    initFirebase();
    showTab('itinerary');
</script>
</body>
</html>
